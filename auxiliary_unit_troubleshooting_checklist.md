# 辅单位写入问题排查清单

## 🔍 问题现象
辅单位卡片中的新单位没有写入产品单位关联表

## 📋 排查步骤

### 1. 检查辅单位数据构建 ✅
- 在辅单位编辑页面添加一个辅单位
- 设置换算率（必须大于0且不等于1）
- 点击返回按钮
- **查看控制台输出**，确认以下信息：
  ```
  🔍 [DEBUG] ==================== 开始构建产品单位 ====================
  🔍 [DEBUG] 产品ID: xxx
  🔍 [DEBUG] 基本单位ID: xxx
  🔍 [DEBUG] 辅单位数量: x
  ```

### 2. 检查单位对象创建 ⚠️
**关键检查点**：
- 辅单位的 `unit` 对象是否为null
- 单位ID是否为空
- 换算率是否有效（> 0 且 ≠ 1）

**常见问题**：
```
❌ 警告: 单位对象为null
❌ 警告: 单位ID为空  
❌ 警告: 换算率无效
```

### 3. 检查产品编辑页面接收 ✅
在产品编辑页面提交表单时，查看：
```
🔍 [DEBUG] ==================== 开始保存产品单位 ====================
🔍 [DEBUG] 传入单位数量: x
```

### 4. 检查数据库写入 ✅
查看仓储层日志：
```
🗃️ 仓储层：替换产品单位配置，产品ID: xxx，新单位数量: x
🗃️ 仓储层：产品单位配置替换完成
```

## 🚨 常见问题及解决方案

### 问题1：单位对象为null
**原因**：在 `_onAuxiliaryUnitNameChanged` 方法中单位创建失败
**解决**：
1. 检查单位名称是否为空
2. 检查数据库连接是否正常
3. 检查单位创建逻辑

### 问题2：换算率无效
**原因**：用户输入验证问题
**解决**：
1. 确保换算率输入框有值
2. 确保换算率 > 0 且 ≠ 1
3. 检查数据类型转换

### 问题3：产品单位ID重复
**原因**：ID生成逻辑问题
**解决**：使用时间戳+随机数生成唯一ID

### 问题4：事务回滚
**原因**：数据库操作失败
**解决**：检查所有相关表的约束条件

## 🔧 快速修复方案

### 临时解决方案1：强制保存
在 `_saveProductUnits` 方法中添加：
```dart
// 临时：逐个保存单位
for (final unit in list) {
  try {
    await ctrl.addProductUnit(unit);
    print('强制保存成功: ${unit.productUnitId}');
  } catch (e) {
    print('强制保存失败: $e');
  }
}
```

### 临时解决方案2：数据验证
在构建产品单位前添加验证：
```dart
// 验证辅单位数据
for (final aux in _auxiliaryUnits) {
  if (aux.unit == null) {
    print('❌ 发现null单位，尝试重新创建');
    // 重新创建单位逻辑
  }
}
```

## 📊 数据库检查命令

```sql
-- 检查产品单位表
SELECT * FROM product_units_table WHERE product_id = 'your_product_id';

-- 检查单位表
SELECT * FROM units_table WHERE name LIKE '%your_unit_name%';

-- 检查表约束
PRAGMA table_info(product_units_table);
```

## 🎯 重点关注

1. **单位创建时机**：确保在构建ProductUnit之前，Unit已经存在于数据库中
2. **数据传递链路**：辅单位页面 → 产品页面 → 控制器 → 仓储 → 数据库
3. **事务完整性**：确保所有相关操作在同一事务中完成
4. **错误处理**：每个环节都要有适当的错误处理和日志记录

## ✅ 验证成功标志

当看到以下日志时，说明问题已解决：
```
🔍 [DEBUG] ✅ 添加辅单位: new_xxx_unit_id
🔍 [DEBUG] ✅ 产品单位保存成功
🗃️ 仓储层：产品单位配置替换完成
```