# 连续扫码历史记录功能使用说明

## 功能概述

在连续扫码模式下，扫码屏幕现在可以显示：
- 最近10次扫码成功的商品名称
- 扫码总数量统计

## 使用方法

### 1. 基本使用（启用历史记录）

```dart
// 使用 BarcodeScannerService 扫描产品条码，并显示历史记录
final barcode = await BarcodeScannerService.scanForProduct(
  context,
  continuousMode: true,  // 启用连续扫码
  showScanHistory: true, // 显示扫码历史
  getProductName: (barcode) async {
    // 根据条码获取商品名称的回调函数
    // 这里可以调用你的 API 或数据库查询
    final product = await productRepository.getProductByBarcode(barcode);
    return product?.name;
  },
);
```

### 2. 使用通用扫码方法

```dart
final barcode = await BarcodeScannerService.scan(
  context,
  config: const BarcodeScannerConfig(
    title: '连续扫码',
    subtitle: '将商品条码对准扫描框',
    continuousMode: true,
    showScanHistory: true,  // 启用历史记录显示
    maxHistoryItems: 10,    // 最多显示10条记录
  ),
  getProductName: (barcode) async {
    // 获取商品名称的逻辑
    return await fetchProductName(barcode);
  },
);
```

### 3. 直接使用 UniversalBarcodeScanner 组件

```dart
UniversalBarcodeScanner(
  config: const BarcodeScannerConfig(
    title: '连续扫码',
    continuousMode: true,
    showScanHistory: true,
    maxHistoryItems: 10,
  ),
  onBarcodeScanned: (barcode) {
    // 处理扫码结果
    print('扫描到条码: $barcode');
  },
  getProductName: (barcode) async {
    // 根据条码返回商品名称
    // 如果返回 null，将显示"未知商品"
    return await getProductNameFromDatabase(barcode);
  },
)
```

## 配置参数说明

### BarcodeScannerConfig 新增参数

- `showScanHistory`: bool - 是否显示扫码历史记录（默认 false）
- `maxHistoryItems`: int - 最大历史记录数量（默认 10）

### UniversalBarcodeScanner 新增参数

- `getProductName`: GetProductName? - 获取商品名称的回调函数
  - 类型: `Future<String?> Function(String barcode)`
  - 参数: barcode - 扫描到的条码
  - 返回: 商品名称，如果返回 null 则显示"未知商品"

## 界面显示

扫码历史区域会显示：

```
┌─────────────────────────────────────┐
│ 扫码记录              总计: 15      │
├─────────────────────────────────────┤
│ ① 可口可乐 500ml                    │
│   6901234567890                     │
├─────────────────────────────────────┤
│ ② 农夫山泉 550ml                    │
│   6902345678901                     │
├─────────────────────────────────────┤
│ ③ 康师傅方便面                      │
│   6903456789012                     │
└─────────────────────────────────────┘
```

## 注意事项

1. **商品名称获取**: `getProductName` 回调是异步的，可以在其中调用 API 或查询数据库
2. **性能考虑**: 如果获取商品名称较慢，不会阻塞扫码流程，商品名称会在获取后更新
3. **历史记录限制**: 默认只保留最近10条记录，可通过 `maxHistoryItems` 调整
4. **连续扫码**: 必须同时启用 `continuousMode` 和 `showScanHistory` 才能看到历史记录累积

## 完整示例

```dart
import 'package:flutter/material.dart';
import 'package:stocko_app/core/services/barcode_scanner_service.dart';

class ContinuousScanPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('连续扫码示例')),
      body: Center(
        child: ElevatedButton(
          onPressed: () async {
            final result = await BarcodeScannerService.scanForProduct(
              context,
              continuousMode: true,
              showScanHistory: true,
              getProductName: (barcode) async {
                // 模拟从数据库获取商品名称
                await Future.delayed(Duration(milliseconds: 200));
                
                // 这里应该是实际的数据库查询
                final products = {
                  '6901234567890': '可口可乐 500ml',
                  '6902345678901': '农夫山泉 550ml',
                  '6903456789012': '康师傅方便面',
                };
                
                return products[barcode];
              },
            );
            
            if (result != null) {
              print('最后扫描的条码: $result');
            }
          },
          child: Text('开始连续扫码'),
        ),
      ),
    );
  }
}
```

## 数据结构

### ScanHistoryItem

扫码历史记录项的数据结构：

```dart
class ScanHistoryItem {
  final String barcode;        // 条码
  final String? productName;   // 商品名称（可选）
  final DateTime timestamp;    // 扫码时间

  ScanHistoryItem({
    required this.barcode,
    this.productName,
    required this.timestamp,
  });
}
```
