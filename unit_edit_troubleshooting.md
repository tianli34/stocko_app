# 产品单位编辑功能问题排查指南

## 问题描述

您在应用日志中看到以下信息：
```
I/flutter (30564): 🔧 ProductAddEditScreen: 获取到 0 个产品单位
I/flutter (30564): 🔧 UnitEditScreen: 没有初始单位数据
```

## 这是正常行为吗？

**是的，这是完全正常的行为。** 这说明：

1. ✅ 系统正常工作
2. ✅ 产品存在（ID: 1749698901282）
3. ✅ 该产品之前没有配置过单位
4. ✅ 系统准备让用户从零开始配置单位

## 如何验证功能正常

### 第一步：配置产品单位
1. 在产品编辑页面，点击"管理单位"按钮
2. 在单位编辑页面：
   - 点击"请选择基本单位"，选择一个单位（如"个"、"件"等）
   - 可选：添加辅单位（如"箱"、"盒"等）并设置换算率
   - 点击右上角的 ✓ 保存

### 第二步：验证保存成功
保存成功后应该看到：
- 🟢 绿色提示："单位配置保存成功"
- 自动返回到产品编辑页面
- 单位字段显示选择的基本单位

### 第三步：验证数据持久性
1. 关闭应用重新打开
2. 再次编辑同一个产品
3. 点击"管理单位"
4. 应该能看到之前保存的单位配置

## 预期的日志变化

配置单位后，再次编辑该产品时，日志应该显示：
```
I/flutter: 🔧 ProductAddEditScreen: 获取到 2 个产品单位  // 示例：基本单位+辅单位
I/flutter: 🔧 UnitEditScreen: 发现 2 个初始单位
```

## 常见问题排查

### Q: 保存后还是显示0个单位？
**可能原因：**
- 保存时出现错误（应该有红色错误提示）
- 数据库连接问题
- 产品ID不匹配

**解决方法：**
1. 查看保存时是否有错误提示
2. 确保选择了基本单位后再保存
3. 检查网络连接

### Q: 点击保存没有反应？
**可能原因：**
- 没有选择基本单位
- 表单验证失败

**解决方法：**
1. 确保至少选择了一个基本单位
2. 检查所有必填字段
3. 查看是否有验证错误提示

### Q: 应用崩溃或卡死？
**解决方法：**
1. 重启应用
2. 清除应用缓存
3. 检查设备存储空间

## 技术说明

这个行为的技术原理：

```dart
// 1. 系统尝试获取现有单位配置
final productUnits = await getProductUnitsByProductId(productId);

// 2. 如果产品从未配置过单位，返回空列表
if (productUnits.isEmpty) {
  print('🔧 获取到 0 个产品单位'); // 这就是您看到的日志
}

// 3. 传递给单位编辑屏幕
UnitEditScreen(
  productId: productId,
  initialProductUnits: productUnits, // 空列表
)

// 4. 单位编辑屏幕检测到空列表
if (initialProductUnits.isEmpty) {
  print('🔧 没有初始单位数据'); // 这就是您看到的日志
  // 准备让用户配置新单位
}
```

## 总结

看到"获取到 0 个产品单位"和"没有初始单位数据"是正常的，这意味着：

1. ✅ 系统功能正常
2. ✅ 产品存在但未配置单位
3. ✅ 现在可以开始配置单位

按照上述步骤配置单位后，这些日志消息将会变为显示实际的单位数量。
