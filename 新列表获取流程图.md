# 新列表获取流程图

## 简化流程

```
┌─────────────────────────────────────────────────────────────┐
│                      用户操作界面                             │
│  - 添加辅单位（箱、件、打等）                                 │
│  - 输入换算率（1箱=12瓶）                                     │
│  - 输入价格（零售价、批发价）                                 │
│  - 删除不需要的辅单位                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              unitEditFormProvider (状态管理)                 │
│                                                              │
│  UnitEditFormState {                                        │
│    auxiliaryUnits: [                                        │
│      AuxiliaryUnitData {                                    │
│        id: 1,              // 临时ID（UI用）                │
│        unitName: "箱",                                       │
│        conversionRate: 12,                                  │
│        retailPriceInCents: "6000",  // 60元                 │
│        wholesalePriceInCents: "5500" // 55元                │
│      },                                                      │
│      AuxiliaryUnitData {                                    │
│        id: 2,                                                │
│        unitName: "件",                                       │
│        conversionRate: 24,                                  │
│        retailPriceInCents: "11000",                         │
│        wholesalePriceInCents: "10000"                       │
│      }                                                       │
│    ]                                                         │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    用户点击"保存"按钮                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              submitForm() - 提交表单                         │
│  1. 读取 unitEditFormProvider 状态                          │
│  2. 验证数据                                                 │
│  3. 构建 ProductFormData                                    │
│  4. 调用 controller.submitForm()                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│         _saveProductUnits() - 构建新列表                     │
│                                                              │
│  // 1. 读取表单状态                                          │
│  final formState = ref.read(unitEditFormProvider);         │
│  final auxiliaryUnits = formState.auxiliaryUnits;          │
│                                                              │
│  // 2. 创建新列表                                            │
│  final list = <UnitProduct>[];                              │
│                                                              │
│  // 3. 添加基础单位                                          │
│  list.add(UnitProduct(                                      │
│    productId: 100,                                          │
│    unitId: 1,        // 瓶                                  │
│    conversionRate: 1 // 基础单位固定为1                     │
│  ));                                                         │
│                                                              │
│  // 4. 遍历辅单位，添加到列表                                │
│  for (auxUnit in auxiliaryUnits) {                          │
│    // 根据单位名称查找 unitId                                │
│    Unit? unit = allUnits.where(                             │
│      (u) => u.name == auxUnit.unitName                      │
│    ).firstOrNull;                                            │
│                                                              │
│    list.add(UnitProduct(                                    │
│      productId: 100,                                        │
│      unitId: unit.id,  // 从单位表获取                      │
│      conversionRate: auxUnit.conversionRate,                │
│      sellingPriceInCents: int.parse(auxUnit.retailPrice),   │
│      wholesalePriceInCents: int.parse(auxUnit.wholesalePrice)│
│    ));                                                       │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    新列表 (list)                             │
│                                                              │
│  [                                                           │
│    UnitProduct(                                             │
│      productId: 100,                                        │
│      unitId: 1,           // 瓶                             │
│      conversionRate: 1                                      │
│    ),                                                        │
│    UnitProduct(                                             │
│      productId: 100,                                        │
│      unitId: 2,           // 箱                             │
│      conversionRate: 12,                                    │
│      sellingPriceInCents: 6000,                             │
│      wholesalePriceInCents: 5500                            │
│    ),                                                        │
│    UnitProduct(                                             │
│      productId: 100,                                        │
│      unitId: 4,           // 件                             │
│      conversionRate: 24,                                    │
│      sellingPriceInCents: 11000,                            │
│      wholesalePriceInCents: 10000                           │
│    )                                                         │
│  ]                                                           │
│                                                              │
│  注意：新列表中的 UnitProduct 没有 id 字段！                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│         replaceProductUnits(productId, list)                │
│                    差异更新逻辑                               │
└─────────────────────────────────────────────────────────────┘
```

## 关键数据转换

### 1. 用户输入 → 表单状态

```
用户输入:
  单位名称: "箱"
  换算率: 12
  零售价: 60 (元)
  批发价: 55 (元)

↓ 转换为

AuxiliaryUnitData:
  id: 1                          // 临时ID（仅UI使用）
  unitName: "箱"
  conversionRate: 12
  retailPriceInCents: "6000"     // 转换为分
  wholesalePriceInCents: "5500"  // 转换为分
```

### 2. 表单状态 → UnitProduct

```
AuxiliaryUnitData:
  unitName: "箱"
  conversionRate: 12
  retailPriceInCents: "6000"

↓ 查找单位表 + 转换

UnitProduct:
  productId: 100
  unitId: 2                      // 从单位表查找得到
  conversionRate: 12
  sellingPriceInCents: 6000      // 字符串转整数
  wholesalePriceInCents: 5500
  // 注意：没有 id 字段！
```

### 3. 新列表 → 差异更新

```
新列表（无 id）:
  [
    { unitId: 1, conversionRate: 1 },
    { unitId: 2, conversionRate: 12, price: 6000 }
  ]

旧列表（有 id，从数据库）:
  [
    { id: 10, unitId: 1, conversionRate: 1 },
    { id: 20, unitId: 2, conversionRate: 12, price: 5500 }
  ]

↓ 差异分析

操作:
  unitId=1: 无变化 → 跳过
  unitId=2: 价格变化 → UPDATE id=20 SET price=6000

结果:
  [
    { id: 10, unitId: 1, conversionRate: 1 },          ← id 不变
    { id: 20, unitId: 2, conversionRate: 12, price: 6000 }  ← id 不变
  ]
```

## 核心要点

### 新列表的特征

| 特征 | 说明 |
|------|------|
| **来源** | 用户在辅单位编辑页面的输入 |
| **管理** | unitEditFormProvider 状态管理 |
| **构建** | _saveProductUnits() 方法 |
| **内容** | 基础单位 + 所有辅单位 |
| **id 字段** | ❌ 没有（或为 null） |
| **unitId** | ✅ 有（从单位表查找） |
| **用途** | 传递给差异更新逻辑 |

### 为什么新列表没有 id？

1. **用户不关心 id**：用户只关心"我要哪些单位、换算率是多少、价格是多少"
2. **id 是数据库的事**：id 由数据库自动生成和管理
3. **差异更新负责匹配**：通过 `unitId` 匹配旧记录，保持 id 不变
4. **新增时自动生成**：新增的记录会由数据库自动分配 id

### 数据流总结

```
用户输入 (单位名称、换算率、价格)
    ↓
表单状态 (AuxiliaryUnitData)
    ↓
新列表 (List<UnitProduct>，无 id)
    ↓
差异更新 (与旧列表比对，保持 id)
    ↓
数据库 (最终结果，id 稳定)
```

---

**关键理解**: 新列表是"用户想要什么"，旧列表是"数据库有什么"，差异更新是"如何从旧变成新，同时保持 id 不变"。
