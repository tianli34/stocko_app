# 辅单位编辑页表单数据跨页面持久化功能说明

## 功能概述

本功能实现了辅单位编辑页面表单数据的跨页面持久化，确保用户在页面间切换时不会丢失已输入的辅单位表单数据。

## 核心组件

### 1. 数据模型 - `AuxiliaryUnitData`

位置：`lib/features/product/domain/model/auxiliary_unit_data.dart`

不可变数据类，用于存储单个辅单位的所有表单数据：
- `id`: 唯一标识符
- `unitId`: 单位ID
- `unitName`: 单位名称
- `conversionRate`: 换算率
- `barcode`: 条码
- `retailPrice`: 建议零售价

特性：
- 支持 `copyWith` 方法进行不可变更新
- 包含 `toJson` 和 `fromJson` 方法便于序列化
- 提供数据验证方法 `isValid`

### 2. 状态管理器 - `UnitEditFormNotifier`

位置：`lib/features/product/application/provider/unit_edit_form_providers.dart`

管理整个单位编辑页面的表单状态：
- `UnitEditFormState`: 包含基本单位名称和辅单位数据列表
- `UnitEditFormNotifier`: 提供各种更新方法

主要方法：
- `updateBaseUnitName()`: 更新基本单位名称
- `addAuxiliaryUnit()`: 添加新辅单位
- `removeAuxiliaryUnit()`: 删除指定辅单位
- `updateAuxiliaryUnit*()`: 更新辅单位的各个字段
- `clearAll()`: 清除所有数据

### 3. 单位编辑页面更新

位置：`lib/features/product/presentation/screens/unit_edit_screen.dart`

主要变化：
- 页面初始化时优先从持久化状态加载数据
- 所有表单字段的 `onChanged` 回调都会实时更新持久化状态
- 页面销毁时自动保存表单数据
- 草稿指示器展示持久化数据状态

## 使用流程

### 1. 数据加载顺序

页面初始化时按以下优先级加载数据：
1. **持久化表单数据**（最高优先级）
2. UI状态草稿数据
3. 数据库中的现有配置
4. 传入的参数数据

### 2. 实时数据保存

所有表单操作都会实时更新到持久化状态：
- 基本单位名称输入
- 辅单位名称输入
- 换算率修改
- 条码输入/扫描
- 建议零售价输入
- 添加/删除辅单位
- 单位选择器选择

### 3. 数据清除

用户可以通过以下方式清除持久化数据：
- 点击草稿指示器中的"清除"按钮
- 程序调用 `ref.read(unitEditFormProvider.notifier).clearAll()`

## 验收测试步骤

### 测试场景1：基本持久化功能

1. 从产品列表页面导航到单位编辑页
2. 输入基本单位名称：`件`
3. 添加辅单位：
   - 单位名称：`箱`
   - 换算率：`12`
   - 条码：`1234567890`
   - 建议零售价：`100.00`
4. 点击返回按钮回到产品列表页
5. 再次导航到单位编辑页
6. **验证**：所有输入的数据都应完整显示

### 测试场景2：多辅单位持久化

1. 导航到单位编辑页并添加多个辅单位：
   - 辅单位1：`盒`, 换算率`6`, 条码`111`, 价格`50.00`
   - 辅单位2：`箱`, 换算率`12`, 条码`222`, 价格`100.00`
2. 在第二个辅单位输入一半数据后返回
3. 再次进入页面
4. **验证**：两个辅单位的数据都应保持原状

### 测试场景3：数据清除功能

1. 在单位编辑页输入任意数据
2. 返回后再次进入，确认数据被保持
3. 点击页面顶部的"清除"按钮
4. **验证**：页面应重置为初始状态，不再显示草稿指示器

### 测试场景4：实时更新验证

1. 打开两个相同的单位编辑页面实例（如果支持）
2. 在一个页面中修改数据
3. **验证**：另一个页面应实时反映数据变化（通过Riverpod的响应式特性）

## 技术特点

### 1. 响应式设计
- 使用 Riverpod 的 Consumer Widget 自动响应状态变化
- 草稿指示器能实时反映数据状态

### 2. 内存效率
- 数据只在需要时加载和保存
- 使用不可变数据结构减少内存开销

### 3. 数据一致性
- 所有数据操作都通过统一的状态管理器
- 避免了多处修改数据造成的不一致

### 4. 用户体验
- 无感知的数据保存，用户无需手动操作
- 清晰的草稿状态指示
- 简单的数据清除操作

## 扩展建议

1. **本地存储集成**：可以将持久化数据保存到设备本地存储，实现跨应用会话的数据保持
2. **自动保存定时器**：添加定时自动保存功能
3. **数据版本控制**：为持久化数据添加版本号，便于兼容性处理
4. **批量操作优化**：对频繁的数据更新操作进行节流处理

## 错误处理

系统包含完整的错误处理机制：
- 数据加载失败时回退到默认状态
- 数据保存失败时不影响用户界面操作
- 所有异常都有相应的日志输出便于调试
