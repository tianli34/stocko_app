# 单位编辑页面草稿功能使用说明

## 功能概述

现在 `UnitEditScreen` 支持草稿保存功能，让用户在编辑单位配置时不会丢失已输入的数据。

## 新增功能

### 1. 自动草稿保存
- **实时保存**：当用户选择基本单位、添加/删除辅单位、修改换算率、输入条码或零售价时，系统会自动保存草稿
- **无需手动操作**：用户不需要特别的操作，编辑过程中会自动保存

### 2. 手动草稿保存
- **保存草稿按钮**：在应用栏中添加了保存草稿按钮（💾图标）
- **即时反馈**：点击后会显示"草稿已保存"的提示信息

### 3. 草稿状态提示
- **可视化提示**：当页面加载草稿数据时，会在顶部显示蓝色提示条
- **明确状态**：用户可以清楚地知道当前显示的是草稿内容

### 4. 草稿数据恢复
- **自动加载**：用户再次进入相同产品的单位编辑页面时，会优先加载草稿数据
- **优先级**：草稿数据 > 数据库中的原始数据

### 5. 草稿清理
- **自动清理**：当用户点击"确认保存"按钮正式提交时，相应的草稿会被自动清除
- **避免冲突**：确保草稿不会与已保存的数据产生冲突

## 使用场景

### 场景1：中途退出编辑
1. 用户开始编辑产品单位
2. 选择了基本单位，添加了几个辅单位
3. 突然需要退出页面（接电话、查看其他信息等）
4. 再次进入时，之前的编辑内容会自动恢复

### 场景2：数据输入过程保护
1. 用户正在输入复杂的单位配置
2. 输入了多个辅单位的换算率、条码、零售价
3. 意外误触返回按钮
4. 重新进入时，所有数据都会保持不变

### 场景3：分步骤编辑
1. 用户先配置基本的单位信息
2. 保存草稿后去查询其他相关信息
3. 返回继续完善剩余的配置
4. 最终完成后正式提交

## 技术实现

### 状态管理
- 使用 `Riverpod` 的 `StateNotifier` 管理草稿状态
- 在应用生命周期内保持草稿数据

### 数据结构
```dart
class UnitEditDraftState {
  final Map<String, List<ProductUnit>> drafts;
}
```

### 关键方法
- `saveDraft()`: 保存草稿
- `getDraft()`: 获取草稿
- `clearDraft()`: 清除草稿
- `_autoSaveDraft()`: 自动保存草稿

## 界面变化

### 应用栏（AppBar）
- **新增按钮**：💾 保存草稿按钮
- **原有按钮**：✓ 确认保存按钮

### 页面内容
- **草稿提示**：蓝色信息条，显示"当前显示的是您上次编辑的草稿内容"
- **原有内容**：基本单位选择、辅单位配置等功能保持不变

## 注意事项

1. **草稿数据仅在应用运行期间有效**：关闭应用后草稿会丢失
2. **产品ID为空时不保存草稿**：新产品编辑时需要先确定产品ID
3. **正式提交会清除草稿**：避免草稿数据与真实数据冲突
4. **自动保存有延迟**：避免频繁保存影响性能

## 用户体验改进

- ✅ **防止数据丢失**：用户不再担心意外退出导致数据丢失
- ✅ **灵活编辑**：支持分步骤、多次编辑
- ✅ **状态明确**：清楚地显示当前数据状态
- ✅ **操作简单**：大部分情况下无需手动保存

## 开发者说明

如果需要在其他页面实现类似的草稿功能，可以参考以下文件：
- `unit_draft_providers.dart`: 草稿状态管理
- `unit_edit_screen.dart`: 草稿功能的具体实现
