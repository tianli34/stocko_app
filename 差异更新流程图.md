# 产品单位差异更新流程图

## 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│                    replaceProductUnits()                     │
│                         开始事务                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤1: 获取现有产品单位                                      │
│  SELECT * FROM unit_product WHERE product_id = ?            │
│  结果: existingUnits = [瓶(ID:1), 箱(ID:2)]                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤2: 构建映射表                                            │
│  existingMap = { 1: 瓶(ID:1), 2: 箱(ID:2) }                 │
│  newMap = { 1: 瓶, 2: 箱(价格变), 3: 件 }                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤3: 差异分析                                              │
│                                                              │
│  遍历 existingMap:                                           │
│    unitId=1 在 newMap 中? ✅ → 检查是否需要更新              │
│    unitId=2 在 newMap 中? ✅ → 检查是否需要更新              │
│                                                              │
│  遍历 newMap:                                                │
│    unitId=1 在 existingMap 中? ✅ → 比较字段                 │
│    unitId=2 在 existingMap 中? ✅ → 比较字段（价格变化）     │
│    unitId=3 在 existingMap 中? ❌ → 标记为新增               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤4: 分类结果                                              │
│  toDelete = []                                               │
│  toUpdate = [箱(ID:2, 新价格)]                              │
│  toInsert = [件(unitId:3)]                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤5: 执行删除操作                                          │
│  if (toDelete.isNotEmpty) {                                 │
│    for (id in toDelete) {                                   │
│      DELETE FROM unit_product WHERE id = ?                  │
│    }                                                         │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤6: 执行更新操作                                          │
│  if (toUpdate.isNotEmpty) {                                 │
│    for (companion in toUpdate) {                            │
│      UPDATE unit_product SET ... WHERE id = ?               │
│    }                                                         │
│  }                                                           │
│  → 更新箱(ID:2)的价格                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤7: 执行新增操作                                          │
│  if (toInsert.isNotEmpty) {                                 │
│    INSERT INTO unit_product (...) VALUES (...)              │
│  }                                                           │
│  → 插入件(unitId:3, 新ID自动生成)                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                         提交事务                              │
│                          完成                                 │
└─────────────────────────────────────────────────────────────┘
```

## 具体示例

### 场景：修改产品的辅单位配置

**初始状态（数据库）：**
```
unit_product 表:
┌────┬────────────┬─────────┬──────────────┬──────────────┐
│ ID │ product_id │ unit_id │ conv_rate    │ selling_price│
├────┼────────────┼─────────┼──────────────┼──────────────┤
│ 1  │ 100        │ 1 (瓶)  │ 1            │ 500 (5元)    │
│ 2  │ 100        │ 2 (箱)  │ 12           │ 5500 (55元)  │
│ 3  │ 100        │ 3 (打)  │ 12           │ 5500 (55元)  │
└────┴────────────┴─────────┴──────────────┴──────────────┘
```

**用户操作：**
1. 保留瓶（不变）
2. 修改箱的价格：55元 → 60元
3. 删除打
4. 新增件（换算率24，价格110元）

**新数据（传入）：**
```
newUnits = [
  UnitProduct(productId: 100, unitId: 1, conversionRate: 1, sellingPrice: 500),
  UnitProduct(productId: 100, unitId: 2, conversionRate: 12, sellingPrice: 6000),
  UnitProduct(productId: 100, unitId: 4, conversionRate: 24, sellingPrice: 11000),
]
```

**差异分析结果：**
```
┌──────────┬─────────┬──────────────────────────────────┐
│ 操作类型  │ unit_id │ 说明                             │
├──────────┼─────────┼──────────────────────────────────┤
│ 保持不变  │ 1 (瓶)  │ 所有字段相同，跳过               │
│ 更新      │ 2 (箱)  │ 价格变化，更新 ID=2 的记录       │
│ 删除      │ 3 (打)  │ 不在新列表中，删除 ID=3 的记录   │
│ 新增      │ 4 (件)  │ 不在旧列表中，插入新记录         │
└──────────┴─────────┴──────────────────────────────────┘
```

**执行的SQL操作：**
```sql
-- 1. 删除操作
DELETE FROM unit_product WHERE id = 3;

-- 2. 更新操作
UPDATE unit_product 
SET selling_price_in_cents = 6000, last_updated = NOW() 
WHERE id = 2;

-- 3. 新增操作
INSERT INTO unit_product (product_id, unit_id, conversion_rate, selling_price_in_cents) 
VALUES (100, 4, 24, 11000);
```

**最终状态（数据库）：**
```
unit_product 表:
┌────┬────────────┬─────────┬──────────────┬──────────────┐
│ ID │ product_id │ unit_id │ conv_rate    │ selling_price│
├────┼────────────┼─────────┼──────────────┼──────────────┤
│ 1  │ 100        │ 1 (瓶)  │ 1            │ 500 (5元)    │  ← ID不变
│ 2  │ 100        │ 2 (箱)  │ 12           │ 6000 (60元)  │  ← ID不变，价格更新
│ 4  │ 100        │ 4 (件)  │ 24           │ 11000(110元) │  ← 新记录
└────┴────────────┴─────────┴──────────────┴──────────────┘

注意：ID=3 的记录已被删除
```

## 关键优势对比

### 旧方案（全删全插）
```
DELETE FROM unit_product WHERE product_id = 100;
-- 删除了 ID=1, 2, 3 的所有记录

INSERT INTO unit_product (...) VALUES (...);  -- 新 ID=5
INSERT INTO unit_product (...) VALUES (...);  -- 新 ID=6
INSERT INTO unit_product (...) VALUES (...);  -- 新 ID=7

结果：所有 ID 都变了！
如果条码表引用了 ID=2，现在关联就断了！
```

### 新方案（差异更新）
```
DELETE FROM unit_product WHERE id = 3;        -- 只删除不需要的
UPDATE unit_product SET ... WHERE id = 2;     -- 更新需要改的
INSERT INTO unit_product (...) VALUES (...);  -- 只插入新的

结果：ID=1 和 ID=2 保持不变！
条码表的关联关系完好！
```

## 性能对比

### 场景：产品有10个辅单位，只修改1个价格

**旧方案：**
- 10次 DELETE
- 10次 INSERT
- 总计：20次数据库操作

**新方案：**
- 0次 DELETE
- 1次 UPDATE
- 0次 INSERT
- 总计：1次数据库操作

**性能提升：20倍！**

---

**说明**: 这个流程图展示了差异更新的完整过程，包括数据分析、操作分类和执行步骤。
