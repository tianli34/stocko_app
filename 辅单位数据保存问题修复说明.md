# è¾…å•ä½æ•°æ®ä¿å­˜é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
ä»"ç¼–è¾‘è¾…å•ä½é¡µ"è¿”å›åˆ°"ç¼–è¾‘è´§å“é¡µ"æ—¶ï¼Œ**æ•°æ®æ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ° `unitEditFormProvider`**ï¼Œå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. âŒ ç”¨æˆ·ç¬¬ä¸€æ¬¡ç¼–è¾‘è¾…å•ä½åè¿”å›ï¼Œæ•°æ®çœ‹ä¼¼æ­£å¸¸
2. âŒ ä½†å¦‚æœç”¨æˆ·å†æ¬¡ç‚¹å‡»"æ·»åŠ è¾…å•ä½"æŒ‰é’®ï¼Œä¹‹å‰è¾“å…¥çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±
3. âŒ ç”¨æˆ·çœ‹åˆ°ç©ºç™½çš„è¾…å•ä½ç¼–è¾‘é¡µé¢ï¼Œéœ€è¦é‡æ–°è¾“å…¥æ‰€æœ‰æ•°æ®

### é—®é¢˜æ ¹æº

**`_handleReturn()` æ–¹æ³•åªé€šè¿‡ `Navigator.pop()` è¿”å›æ•°æ®ï¼Œä½†æ²¡æœ‰åŒæ­¥ä¿å­˜åˆ° `unitEditFormProvider`**

```dart
// âŒ åŸå§‹ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰
void _handleReturn() {
  final productUnits = _buildProductUnits();
  final auxiliaryBarcodes = _buildAuxiliaryUnitBarcodes();

  if (productUnits.isNotEmpty) {
    // åªè¿”å›æ•°æ®ï¼Œæ²¡æœ‰ä¿å­˜åˆ° provider
    Navigator.of(context).pop({
      'productUnits': productUnits,
      'auxiliaryBarcodes': auxiliaryBarcodes,
    });
  }
}
```

### æ•°æ®æµé—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ“ä½œæµç¨‹                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç¼–è¾‘è´§å“é¡µ â†’ ç‚¹å‡»"æ·»åŠ è¾…å•ä½"                              â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. ç¼–è¾‘è¾…å•ä½é¡µ â†’ è¾“å…¥æ•°æ®ï¼ˆç®±=12ã€ä»¶=24ï¼‰                    â”‚
â”‚    â†“                                                         â”‚
â”‚ 3. è¿”å›ç¼–è¾‘è´§å“é¡µ                                             â”‚
â”‚    âœ… æ•°æ®ä¿å­˜åˆ° productFormUiProvider                        â”‚
â”‚    âŒ æ•°æ®æœªä¿å­˜åˆ° unitEditFormProvider                       â”‚
â”‚    â†“                                                         â”‚
â”‚ 4. å†æ¬¡ç‚¹å‡»"æ·»åŠ è¾…å•ä½"                                       â”‚
â”‚    âŒ unitEditFormProvider æ˜¯ç©ºçš„                             â”‚
â”‚    âŒ é¡µé¢æ˜¾ç¤ºç©ºç™½ï¼Œä¹‹å‰çš„æ•°æ®å…¨éƒ¨ä¸¢å¤±ï¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

åœ¨ `_handleReturn()` æ–¹æ³•ä¸­æ·»åŠ  `_saveCurrentDataToFormProvider()` è°ƒç”¨ï¼Œç¡®ä¿æ•°æ®åŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š

1. âœ… `productFormUiProvider` - ç”¨äºæœ€ç»ˆæäº¤
2. âœ… `unitEditFormProvider` - ç”¨äºå†æ¬¡è¿›å…¥æ—¶æ¢å¤æ•°æ®

### ä¿®å¤åçš„ä»£ç 

```dart
// âœ… ä¿®å¤åçš„ä»£ç 
void _handleReturn() {
  print('ğŸ” å¤„ç†è¿”å›ï¼Œå¼€å§‹æ„å»ºæ•°æ®...');
  try {
    final productUnits = _buildProductUnits();
    final auxiliaryBarcodes = _buildAuxiliaryUnitBarcodes();

    if (productUnits.isNotEmpty) {
      print('ğŸ” æ•°æ®æœ‰æ•ˆï¼Œè¿”å›äº§å“å•ä½æ•°æ®');

      // âœ… å…ˆä¿å­˜åˆ° unitEditFormProviderï¼Œç¡®ä¿ä¸‹æ¬¡è¿›å…¥æ—¶èƒ½æ¢å¤æ•°æ®
      _saveCurrentDataToFormProvider();

      // è¿”å›åŒ…å«äº§å“å•ä½å’Œæ¡ç ä¿¡æ¯çš„æ•°æ®
      Navigator.of(context).pop({
        'productUnits': productUnits,
        'auxiliaryBarcodes': auxiliaryBarcodes,
      });
    } else {
      print('ğŸ” æ•°æ®æ— æ•ˆæˆ–ç¼ºå°‘åŸºæœ¬å•ä½ï¼Œç›´æ¥è¿”å›');
      Navigator.of(context).pop();
    }
  } catch (e, s) {
    print('âŒ è¿”å›å¤„ç†å¼‚å¸¸: $e\n$s');
    Navigator.of(context).pop();
  }
}

/// å°†å½“å‰ç¼–è¾‘çš„è¾…å•ä½æ•°æ®ä¿å­˜åˆ° FormProviderï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–
void _saveCurrentDataToFormProvider() {
  print('ğŸ” ä¿å­˜å½“å‰æ•°æ®åˆ° unitEditFormProvider');
  try {
    final auxiliaryUnitsData = _auxiliaryUnits.map((aux) {
      // å°†å…ƒè½¬æ¢ä¸ºåˆ†å­˜å‚¨
      String retailPriceInCents = '';
      if (aux.retailPriceController.text.trim().isNotEmpty) {
        final priceInYuan = double.tryParse(aux.retailPriceController.text.trim());
        if (priceInYuan != null) {
          retailPriceInCents = (priceInYuan * 100).round().toString();
        }
      }

      String wholesalePriceInCents = '';
      if (aux.wholesalePriceController.text.trim().isNotEmpty) {
        final priceInYuan = double.tryParse(aux.wholesalePriceController.text.trim());
        if (priceInYuan != null) {
          wholesalePriceInCents = (priceInYuan * 100).round().toString();
        }
      }

      return AuxiliaryUnitData(
        id: aux.id,
        unitId: aux.unit?.id,
        unitName: aux.unitController.text.trim(),
        conversionRate: aux.conversionRate,
        barcode: aux.barcodeController.text.trim(),
        retailPriceInCents: retailPriceInCents,
        wholesalePriceInCents: wholesalePriceInCents,
      );
    }).toList();

    ref.read(unitEditFormProvider.notifier).setAuxiliaryUnits(
      auxiliaryUnitsData,
      counter: _auxiliaryCounter,
    );
    print('âœ… æ•°æ®å·²ä¿å­˜åˆ° unitEditFormProviderï¼Œå…± ${auxiliaryUnitsData.length} ä¸ªè¾…å•ä½');
  } catch (e, s) {
    print('âŒ ä¿å­˜æ•°æ®åˆ° FormProvider å¤±è´¥: $e\n$s');
  }
}
```

---

## ä¿®å¤åçš„æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿®å¤åçš„æ•°æ®æµ                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç¼–è¾‘è´§å“é¡µ â†’ ç‚¹å‡»"æ·»åŠ è¾…å•ä½"                              â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. ç¼–è¾‘è¾…å•ä½é¡µ â†’ è¾“å…¥æ•°æ®ï¼ˆç®±=12ã€ä»¶=24ï¼‰                    â”‚
â”‚    â†“ (æ¯æ¬¡è¾“å…¥éƒ½å®æ—¶ä¿å­˜åˆ° unitEditFormProvider)              â”‚
â”‚ 3. è¿”å›ç¼–è¾‘è´§å“é¡µ                                             â”‚
â”‚    âœ… è°ƒç”¨ _saveCurrentDataToFormProvider()                  â”‚
â”‚    âœ… æ•°æ®ä¿å­˜åˆ° unitEditFormProvider                         â”‚
â”‚    âœ… æ•°æ®ä¿å­˜åˆ° productFormUiProvider                        â”‚
â”‚    â†“                                                         â”‚
â”‚ 4. å†æ¬¡ç‚¹å‡»"æ·»åŠ è¾…å•ä½"                                       â”‚
â”‚    âœ… ä» unitEditFormProvider æ¢å¤æ•°æ®                        â”‚
â”‚    âœ… é¡µé¢æ˜¾ç¤ºä¹‹å‰è¾“å…¥çš„æ‰€æœ‰è¾…å•ä½æ•°æ®                         â”‚
â”‚    âœ… ç”¨æˆ·å¯ä»¥ç»§ç»­ç¼–è¾‘æˆ–æ·»åŠ æ–°çš„è¾…å•ä½                         â”‚
â”‚    â†“                                                         â”‚
â”‚ 5. æäº¤è¡¨å•                                                   â”‚
â”‚    âœ… ä» productFormUiProvider è¯»å–æ•°æ®æäº¤                   â”‚
â”‚    âœ… æäº¤æˆåŠŸåæ¸…ç©º unitEditFormProvider                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æ”¹è¿›ç‚¹

### 1. åŒé‡ä¿å­˜æœºåˆ¶
- **å®æ—¶ä¿å­˜**: ç”¨æˆ·æ¯æ¬¡è¾“å…¥éƒ½é€šè¿‡ `onChanged` ä¿å­˜åˆ° `unitEditFormProvider`
- **è¿”å›ä¿å­˜**: è¿”å›æ—¶å†æ¬¡å®Œæ•´ä¿å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 2. ä»·æ ¼å•ä½è½¬æ¢
```dart
// ç”¨æˆ·è¾“å…¥: 12.50 å…ƒ
// ä¿å­˜åˆ° provider: "1250" (åˆ†)
// æäº¤åˆ°æ•°æ®åº“: 1250 (æ•´æ•°)
```

### 3. æ•°æ®æ¢å¤é€»è¾‘
```dart
void _initializeUnits() async {
  // ç¼–è¾‘æ¨¡å¼ï¼šä»æ•°æ®åº“åŠ è½½
  if (widget.productId != null) {
    await _initializeAuxiliaryUnits();
    return;
  }

  // æ–°å¢æ¨¡å¼ï¼šä» unitEditFormProvider æ¢å¤
  final formState = ref.read(unitEditFormProvider);
  if (formState.auxiliaryUnits.isNotEmpty) {
    _loadFromFormProvider(); // âœ… æ¢å¤ä¹‹å‰ç¼–è¾‘çš„æ•°æ®
    return;
  }

  // æ— æ•°æ®ï¼šåˆ›å»ºç©ºç™½è¡¨å•
  await _initializeAuxiliaryUnits();
}
```

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å¤šæ¬¡è¿›å‡ºè¾…å•ä½é¡µé¢
1. âœ… è¿›å…¥è¾…å•ä½é¡µé¢ï¼Œæ·»åŠ "ç®±"ï¼ˆæ¢ç®—ç‡12ï¼‰
2. âœ… è¿”å›è´§å“é¡µé¢
3. âœ… å†æ¬¡è¿›å…¥è¾…å•ä½é¡µé¢
4. âœ… éªŒè¯ï¼š"ç®±"çš„æ•°æ®ä»ç„¶å­˜åœ¨
5. âœ… æ·»åŠ "ä»¶"ï¼ˆæ¢ç®—ç‡24ï¼‰
6. âœ… è¿”å›è´§å“é¡µé¢
7. âœ… å†æ¬¡è¿›å…¥è¾…å•ä½é¡µé¢
8. âœ… éªŒè¯ï¼š"ç®±"å’Œ"ä»¶"çš„æ•°æ®éƒ½å­˜åœ¨

### åœºæ™¯ 2: ç¼–è¾‘åæäº¤
1. âœ… ç¼–è¾‘è¾…å•ä½æ•°æ®
2. âœ… è¿”å›è´§å“é¡µé¢
3. âœ… æäº¤è¡¨å•
4. âœ… éªŒè¯ï¼šè¾…å•ä½æ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
5. âœ… éªŒè¯ï¼šunitEditFormProvider è¢«æ¸…ç©º

### åœºæ™¯ 3: ç¼–è¾‘æ¨¡å¼
1. âœ… æ‰“å¼€å·²æœ‰è´§å“çš„ç¼–è¾‘é¡µé¢
2. âœ… è¿›å…¥è¾…å•ä½é¡µé¢
3. âœ… éªŒè¯ï¼šä»æ•°æ®åº“åŠ è½½çš„è¾…å•ä½æ•°æ®æ­£ç¡®æ˜¾ç¤º
4. âœ… ä¿®æ”¹è¾…å•ä½æ•°æ®
5. âœ… è¿”å›è´§å“é¡µé¢
6. âœ… å†æ¬¡è¿›å…¥è¾…å•ä½é¡µé¢
7. âœ… éªŒè¯ï¼šä¿®æ”¹åçš„æ•°æ®æ­£ç¡®æ˜¾ç¤º

---

## æ€»ç»“

### é—®é¢˜
âŒ è¿”å›æ—¶æ•°æ®åªä¿å­˜åˆ° `productFormUiProvider`ï¼Œæ²¡æœ‰ä¿å­˜åˆ° `unitEditFormProvider`

### ä¿®å¤
âœ… æ·»åŠ  `_saveCurrentDataToFormProvider()` æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®åŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ª provider

### æ•ˆæœ
âœ… ç”¨æˆ·å¯ä»¥å¤šæ¬¡è¿›å‡ºè¾…å•ä½é¡µé¢ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±
âœ… æ•°æ®åœ¨ `unitEditFormProvider` å’Œ `productFormUiProvider` ä¹‹é—´ä¿æŒåŒæ­¥
âœ… æäº¤æˆåŠŸåæ­£ç¡®æ¸…ç©ºä¸´æ—¶æ•°æ®

---

## ä¿®æ”¹æ–‡ä»¶

- `lib/features/product/presentation/screens/auxiliaryunit_edit_screen.dart`
  - ä¿®æ”¹ `_handleReturn()` æ–¹æ³•
  - æ–°å¢ `_saveCurrentDataToFormProvider()` æ–¹æ³•
