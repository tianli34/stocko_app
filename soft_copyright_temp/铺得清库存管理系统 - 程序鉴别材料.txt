////////////////////////////////////////////////////////////////////////////////
å‰ 30 é¡µ (ç¬¬ 1 - 1500 è¡Œ)
////////////////////////////////////////////////////////////////////////////////

// ============================================================
// æ–‡ä»¶: main.dart
// ============================================================
// lib/main.dart

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:stocko_app/app.dart';
import 'core/services/image_cache_service.dart';
import 'config/flavor_config.dart';
// AppInitializer is now injected inside StockoApp via MaterialApp.builder

Future<void> runStockoApp(FlavorConfig config) async {
  // 1. ç¡®ä¿ Flutter å¼•æ“çš„ç»‘å®šå·²ç»åˆå§‹åŒ–ã€‚
  WidgetsFlutterBinding.ensureInitialized();

  // 2. è®¾ç½®ç³»ç»ŸUIæ ·å¼ï¼Œç§»é™¤åº•éƒ¨å¯¼èˆªæ çš„åŠé€æ˜é®ç½©
  SystemChrome.setSystemUIOverlayStyle(
    const SystemUiOverlayStyle(
      systemNavigationBarColor: Colors.white, // è®¾ç½®ä¸ºç™½è‰²æˆ–é€æ˜
      systemNavigationBarIconBrightness: Brightness.dark, // å›¾æ ‡é¢œè‰²
      systemNavigationBarDividerColor: Colors.transparent, // åˆ†éš”çº¿é€æ˜
    ),
  );

  // å¯ç”¨è¾¹åˆ°è¾¹æ˜¾ç¤ºï¼ˆå¯é€‰ï¼Œè®©åº”ç”¨å†…å®¹å»¶ä¼¸åˆ°ç³»ç»Ÿæ ä¸‹æ–¹ï¼‰
  SystemChrome.setEnabledSystemUIMode(SystemUiMode.edgeToEdge);

  // 3. åˆå§‹åŒ–å›¾ç‰‡ç¼“å­˜æœåŠ¡
  final imageCacheService = ImageCacheService();
  await imageCacheService.initialize();

  // 4. è¿è¡Œåº”ç”¨
  runApp(
    ProviderScope(
      overrides: [flavorConfigProvider.overrideWithValue(config)],
      child: const StockoApp(),
    ),
  );
}

void main() {
  // é»˜è®¤è¿è¡Œ personalized é…ç½®
  runStockoApp(
    FlavorConfig(
      flavor: AppFlavor.personalized,
      appTitle: "å®šåˆ¶ç‰ˆåº“å­˜ç®¡ç†",
      featureFlags: {Feature.showDatabaseTools: true},
    ),
  );
}


// ============================================================
// æ–‡ä»¶: app.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'core/router/router_provider.dart';
import 'core/theme/theme_provider.dart';
import 'core/initialization/app_initializer.dart';

class StockoApp extends ConsumerWidget {
  const StockoApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    print('ğŸ  StockoApp build called');
    final router = ref.watch(routerProvider);
    
    // æ ¹æ®ç³»ç»Ÿä¸»é¢˜æ›´æ–°UIæ ·å¼
    final brightness = MediaQuery.platformBrightnessOf(context);
    AppTheme.updateSystemUIOverlay(brightness);
    
    return AppInitializer(
      child: MaterialApp.router(
        title: 'é“ºå¾—æ¸… åº“å­˜ç®¡ç†ç³»ç»Ÿ',
        theme: AppTheme.lightTheme,
        darkTheme: AppTheme.darkTheme,
        themeMode: ThemeMode.system,
        routerConfig: router,
        debugShowCheckedModeBanner: false,
        localizationsDelegates: const [
          GlobalMaterialLocalizations.delegate,
          GlobalWidgetsLocalizations.delegate,
          GlobalCupertinoLocalizations.delegate,
        ],
        supportedLocales: const [Locale('zh', 'CN'), Locale('en', 'US')],
      ),
    );
  }
}


// ============================================================
// æ–‡ä»¶: main_generic.dart
// ============================================================
// Entry point for the generic flavor
import 'package:stocko_app/config/flavor_config.dart';
import 'package:stocko_app/main.dart' as app;

void main() {
  // å®šä¹‰é€šç”¨ç‰ˆé…ç½®
  final genericConfig = FlavorConfig(
    flavor: AppFlavor.generic,
    appTitle: "é€šç”¨åº“å­˜ç®¡ç†",
    featureFlags: {
      Feature.showDatabaseTools: false, // é€šç”¨ç‰ˆå…³é—­æ•°æ®åº“å·¥å…·
    },
  );

  // ä½¿ç”¨é€šç”¨é…ç½®è¿è¡Œåº”ç”¨
  app.runStockoApp(genericConfig);
}

// ============================================================
// æ–‡ä»¶: main_personalized.dart
// ============================================================
// Entry point for the personalized flavor
import 'package:stocko_app/config/flavor_config.dart';
import 'package:stocko_app/main.dart' as app;

void main() {
  // å®šä¹‰å®šåˆ¶ç‰ˆé…ç½®
  final personalizedConfig = FlavorConfig(
    flavor: AppFlavor.personalized,
    appTitle: "å®šåˆ¶ç‰ˆåº“å­˜ç®¡ç†",
    featureFlags: {
      Feature.showDatabaseTools: true, // å®šåˆ¶ç‰ˆä¿ç•™æ•°æ®åº“å·¥å…·
    },
  );

  // ä½¿ç”¨å®šåˆ¶é…ç½®è¿è¡Œåº”ç”¨
  app.runStockoApp(personalizedConfig);
}

// ============================================================
// æ–‡ä»¶: core\database\database_initializer.dart
// ============================================================
import 'package:drift/drift.dart';
import 'database.dart';

/// æ•°æ®åº“åˆå§‹åŒ–æœåŠ¡
/// è´Ÿè´£åˆå§‹åŒ–å„ç§é»˜è®¤æ•°æ®
class DatabaseInitializer {
  final AppDatabase _database;

  DatabaseInitializer(this._database);

  /// åˆå§‹åŒ–æ‰€æœ‰é»˜è®¤æ•°æ®
  Future<void> initializeAllDefaults() async {
    await initializeDefaultShops();
    await initializeDefaultCategories();
    await initializeDefaultUnits();
    await initializeDefaultProducts();
    await initializeDefaultProductUnits();
    await initializeDefaultBarcodes();
    await initializeDefaultCustomers();
    // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–åˆå§‹åŒ–æ–¹æ³•
  }

  /// åˆå§‹åŒ–é»˜è®¤åº—é“º
  Future<void> initializeDefaultShops() async {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
      final count = await (_database.select(
        _database.shop,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸª åº—é“ºæ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultShops = [
        ShopCompanion.insert(
          id: Value(1),
          name: 'é•¿å±±çš„åº—',
          manager: 'changshan',
          
          updatedAt: Value(DateTime.now()),
        ),
        ShopCompanion.insert(
          id: Value(2),
          name: 'ç”°ç«‹çš„åº—',
          manager: 'tianli',
          
          updatedAt: Value(DateTime.now()),
        ),
      ];

      // ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥
      await _database.transaction(() async {
        for (final shop in defaultShops) {
          await _database.into(_database.shop).insert(shop);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultShops.length} ä¸ªé»˜è®¤åº—é“º');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤åº—é“ºå¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤ç±»åˆ«
  Future<void> initializeDefaultCategories() async {
    try {
      final count = await (_database.select(
        _database.category,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ“‚ ç±»åˆ«æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultCategories = [
        CategoryCompanion.insert(
          id: const Value(1),
          name: 'é£Ÿå“',
        ),
        CategoryCompanion.insert(
          id: const Value(2),
          name: 'é¥®æ–™',
        ),
        CategoryCompanion.insert(
          id: const Value(3),
          name: 'æ—¥ç”¨å“',
        ),
      ];

      await _database.transaction(() async {
        for (final category in defaultCategories) {
          await _database.into(_database.category).insert(category);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultCategories.length} ä¸ªé»˜è®¤ç±»åˆ«');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤ç±»åˆ«å¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤å•ä½
  Future<void> initializeDefaultUnits() async {
    try {
      final count = await (_database.select(
        _database.unit,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ“ å•ä½æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }
      final defaultUnits = [
        UnitCompanion.insert(
          id: Value(1),
          name: 'ä¸ª',
          
          
        ),
        UnitCompanion.insert(
          id: Value(2),
          name: 'åƒå…‹',
        ),
        UnitCompanion.insert(
          id: Value(3),
          name: 'ç®±',
          
          
        ),
        UnitCompanion.insert(
          id: Value(4),
          name: 'ç“¶',
          
          
        ),
        UnitCompanion.insert(
          id: Value(5),
          name: 'åŒ…',
          
        ),
      ];

      await _database.transaction(() async {
        for (final unit in defaultUnits) {
          await _database.into(_database.unit).insert(unit);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultUnits.length} ä¸ªé»˜è®¤å•ä½');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤å•ä½å¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤å•†å“
  Future<void> initializeDefaultProducts() async {
    try {
      final count = await (_database.select(
        _database.product,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ“¦ å•†å“æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultProducts = [
        ProductCompanion.insert(
          id: const Value(1),
          name: 'å¯å£å¯ä¹',
          categoryId: const Value(2),
          baseUnitId: 4, // ç“¶
        ),
        ProductCompanion.insert(
          id: const Value(2),
          name: 'åº·å¸ˆå‚…å†°çº¢èŒ¶',
          categoryId: const Value(2),
          baseUnitId: 4, // ç“¶
        ),
        ProductCompanion.insert(
          id: const Value(3),
          name: 'å†œå¤«å±±æ³‰',
          categoryId: const Value(2),
          baseUnitId: 4, // ç“¶
        ),
        ProductCompanion.insert(
          id: const Value(4),
          name: 'å¥¥åˆ©å¥¥',
          categoryId: const Value(1),
          baseUnitId: 5, // åŒ…
        ),
        ProductCompanion.insert(
          id: const Value(5),
          name: 'ä¹äº‹è–¯ç‰‡',
          categoryId: const Value(1),
          baseUnitId: 5, // åŒ…
        ),
        ProductCompanion.insert(
          id: const Value(6),
          name: 'ç»Ÿä¸€è€å›é…¸èœç‰›è‚‰é¢',
          categoryId: const Value(1),
          baseUnitId: 5, // åŒ…
        ),
        ProductCompanion.insert(
          id: const Value(7),
          name: 'æ¸…é£æŠ½çº¸',
          categoryId: const Value(3),
          baseUnitId: 5, // åŒ…
        ),
        ProductCompanion.insert(
          id: const Value(8),
          name: 'é«˜éœ²æ´ç‰™è†',
          categoryId: const Value(3),
          baseUnitId: 1, // ä¸ª
        ),
        ProductCompanion.insert(
          id: const Value(9),
          name: 'å¨ƒå“ˆå“ˆADé’™å¥¶',
          categoryId: const Value(2),
          baseUnitId: 4, // ç“¶
        ),
        ProductCompanion.insert(
          id: const Value(10),
          name: 'è¾¾åˆ©å›­è›‹é»„æ´¾',
          categoryId: const Value(1),
          baseUnitId: 5, // åŒ…
        ),
      ];

      await _database.transaction(() async {
        for (final product in defaultProducts) {
          await _database.into(_database.product).insert(product);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultProducts.length} ä¸ªé»˜è®¤å•†å“');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤å•†å“å¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤å•†å“å•ä½å…³è”
  Future<void> initializeDefaultProductUnits() async {
    try {
      final count = await (_database.select(
        _database.unitProduct,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ“¦ äº§å“å•ä½æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultProductUnits = [
        // å¯å£å¯ä¹, ç“¶
        UnitProductCompanion.insert(
          id: const Value(1),
          productId: 1,
          unitId: 4,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // åº·å¸ˆå‚…å†°çº¢èŒ¶, ç“¶
        UnitProductCompanion.insert(
          id: const Value(2),
          productId: 2,
          unitId: 4,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // å†œå¤«å±±æ³‰, ç“¶
        UnitProductCompanion.insert(
          id: const Value(3),
          productId: 3,
          unitId: 4,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // å¥¥åˆ©å¥¥, åŒ…
        UnitProductCompanion.insert(
          id: const Value(4),
          productId: 4,
          unitId: 5,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // ä¹äº‹è–¯ç‰‡, åŒ…
        UnitProductCompanion.insert(
          id: const Value(5),
          productId: 5,
          unitId: 5,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // ç»Ÿä¸€è€å›é…¸èœç‰›è‚‰é¢, åŒ…
        UnitProductCompanion.insert(
          id: const Value(6),
          productId: 6,
          unitId: 5,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // æ¸…é£æŠ½çº¸, åŒ…
        UnitProductCompanion.insert(
          id: const Value(7),
          productId: 7,
          unitId: 5,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // é«˜éœ²æ´ç‰™è†, ä¸ª
        UnitProductCompanion.insert(
          id: const Value(8),
          productId: 8,
          unitId: 1,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // å¨ƒå“ˆå“ˆADé’™å¥¶, ç“¶
        UnitProductCompanion.insert(
          id: const Value(9),
          productId: 9,
          unitId: 4,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
        // è¾¾åˆ©å›­è›‹é»„æ´¾, åŒ…
        UnitProductCompanion.insert(
          id: const Value(10),
          productId: 10,
          unitId: 5,
          conversionRate: 1,
          lastUpdated: Value(DateTime.now()),
        ),
      ];

      await _database.transaction(() async {
        for (final unitProduct in defaultProductUnits) {
          await _database.into(_database.unitProduct).insert(unitProduct);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultProductUnits.length} ä¸ªé»˜è®¤äº§å“å•ä½');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤äº§å“å•ä½å¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤æ¡ç 
  Future<void> initializeDefaultBarcodes() async {
    try {
      final count = await (_database.select(
        _database.barcode,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ·ï¸ æ¡ç æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultBarcodes = [
        BarcodeCompanion.insert(unitProductId: 1, barcodeValue: '6901234567890'), // å¯å£å¯ä¹
        BarcodeCompanion.insert(unitProductId: 2, barcodeValue: '6901234567891'), // åº·å¸ˆå‚…å†°çº¢èŒ¶
        BarcodeCompanion.insert(unitProductId: 3, barcodeValue: '6901234567892'), // å†œå¤«å±±æ³‰
        BarcodeCompanion.insert(unitProductId: 4, barcodeValue: '6901234567893'), // å¥¥åˆ©å¥¥
        BarcodeCompanion.insert(unitProductId: 5, barcodeValue: '6901234567894'), // ä¹äº‹è–¯ç‰‡
        BarcodeCompanion.insert(unitProductId: 6, barcodeValue: '6901234567895'), // ç»Ÿä¸€è€å›é…¸èœç‰›è‚‰é¢
        BarcodeCompanion.insert(unitProductId: 7, barcodeValue: '6901234567896'), // æ¸…é£æŠ½çº¸
        BarcodeCompanion.insert(unitProductId: 8, barcodeValue: '6901234567897'), // é«˜éœ²æ´ç‰™è†
        BarcodeCompanion.insert(unitProductId: 9, barcodeValue: '6901234567898'), // å¨ƒå“ˆå“ˆADé’™å¥¶
        BarcodeCompanion.insert(unitProductId: 10, barcodeValue: '6901234567899'), // è¾¾åˆ©å›­è›‹é»„æ´¾
      ];

      await _database.transaction(() async {
        for (final barcode in defaultBarcodes) {
          await _database.into(_database.barcode).insert(barcode);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultBarcodes.length} ä¸ªé»˜è®¤æ¡ç ');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤æ¡ç å¤±è´¥: $e');
      rethrow;
    }
  }

  /// åˆå§‹åŒ–é»˜è®¤å®¢æˆ·
  Future<void> initializeDefaultCustomers() async {
    try {
      final count = await (_database.select(
        _database.customers,
      )..limit(1)).get();

      if (count.isNotEmpty) {
        print('ğŸ‘¥ å®¢æˆ·æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      final defaultCustomers = [
        CustomersCompanion.insert(
          id: const Value(0),
          name: 'åŒ¿åæ•£å®¢',
        ),
      ];

      await _database.transaction(() async {
        for (final customer in defaultCustomers) {
          await _database.into(_database.customers).insert(customer);
        }
      });

      print('âœ… æˆåŠŸåˆå§‹åŒ– ${defaultCustomers.length} ä¸ªé»˜è®¤å®¢æˆ·');
    } catch (e) {
      print('âŒ åˆå§‹åŒ–é»˜è®¤å®¢æˆ·å¤±è´¥: $e');
      rethrow;
    }
  }

  /// é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼‰
  Future<void> resetAllData() async {
    await _database.transaction(() async {
      // åˆ é™¤é”€å”®ç›¸å…³çš„è¡¨æ•°æ®
      await _database.delete(_database.salesTransactionItem).go();
      await _database.delete(_database.salesTransaction).go();
      await _database.delete(_database.customers).go();

      // åˆ é™¤ä¸šåŠ¡æ•°æ®è¡¨
      await _database.delete(_database.inboundItem).go();
      await _database.delete(_database.inboundReceipt).go();
      await _database.delete(_database.purchaseOrderItem).go();
      await _database.delete(_database.purchaseOrder).go();
      await _database.delete(_database.inventoryTransaction).go();
      await _database.delete(_database.stock).go();
      await _database.delete(_database.productBatch).go();
      await _database.delete(_database.supplier).go();

      // åˆ é™¤åŸºç¡€æ•°æ®è¡¨
      await _database.delete(_database.barcode).go();
      await _database.delete(_database.unitProduct).go();
      await _database.delete(_database.product).go();
      await _database.delete(_database.shop).go();
      await _database.delete(_database.category).go();
      await _database.delete(_database.unit).go();
    });

    await initializeAllDefaults();
    print('ğŸ”„ æ•°æ®åº“å·²é‡ç½®å¹¶é‡æ–°åˆå§‹åŒ–');
  }
}


// ============================================================
// æ–‡ä»¶: core\services\image_cache_service.dart
// ============================================================
import 'dart:io';
import 'dart:ui' as ui;
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:path/path.dart' as path;
import 'package:path_provider/path_provider.dart';

/// å›¾ç‰‡ç¼“å­˜æœåŠ¡
/// æä¾›æœ¬åœ°å›¾ç‰‡ç¼“å­˜ã€å†…å­˜ç¼“å­˜å’Œå›¾ç‰‡ä¼˜åŒ–åŠŸèƒ½
class ImageCacheService {
  static final ImageCacheService _instance = ImageCacheService._internal();
  factory ImageCacheService() => _instance;
  ImageCacheService._internal();

  // å†…å­˜ç¼“å­˜
  final Map<String, ui.Image> _memoryCache = {};
  final Map<String, Uint8List> _byteCache = {};

  // ç¼“å­˜å¤§å°é™åˆ¶
  static const int maxMemoryCacheSize = 50; // æœ€å¤§å†…å­˜ç¼“å­˜å›¾ç‰‡æ•°é‡
  static const int maxByteCacheSize = 20; // æœ€å¤§å­—èŠ‚ç¼“å­˜æ•°é‡

  // ç¼©ç•¥å›¾ç¼“å­˜ç›®å½•
  String? _thumbnailCacheDir;

  /// åˆå§‹åŒ–ç¼“å­˜æœåŠ¡
  Future<void> initialize() async {
    try {
      final Directory appDir = await getApplicationDocumentsDirectory();
      _thumbnailCacheDir = path.join(appDir.path, 'image_cache', 'thumbnails');

      // åˆ›å»ºç¼“å­˜ç›®å½•
      final Directory cacheDir = Directory(_thumbnailCacheDir!);
      if (!await cacheDir.exists()) {
        await cacheDir.create(recursive: true);
      }

      debugPrint('å›¾ç‰‡ç¼“å­˜æœåŠ¡åˆå§‹åŒ–å®Œæˆ: $_thumbnailCacheDir');
    } catch (e) {
      debugPrint('å›¾ç‰‡ç¼“å­˜æœåŠ¡åˆå§‹åŒ–å¤±è´¥: $e');
    }
  }

  /// è·å–ä¼˜åŒ–åçš„å›¾ç‰‡
  /// [imagePath] åŸå§‹å›¾ç‰‡è·¯å¾„
  /// [width] ç›®æ ‡å®½åº¦
  /// [height] ç›®æ ‡é«˜åº¦
  /// [quality] å‹ç¼©è´¨é‡ (0-100)
  Future<Uint8List?> getOptimizedImage(
    String imagePath, {
    int? width,
    int? height,
    int quality = 100,
    DateTime? fileModifiedTime,
  }) async {
    try {
      // ç”Ÿæˆç¼“å­˜é”®
      final cacheKey =
          _generateCacheKey(imagePath, width, height, quality, fileModifiedTime);

      // æ£€æŸ¥å­—èŠ‚ç¼“å­˜
      if (_byteCache.containsKey(cacheKey)) {
        debugPrint('ä»å­—èŠ‚ç¼“å­˜åŠ è½½å›¾ç‰‡: $cacheKey');
        return _byteCache[cacheKey];
      }

      // æ£€æŸ¥ç£ç›˜ç¼“å­˜
      final cachedBytes = await _getCachedThumbnail(cacheKey);
      if (cachedBytes != null) {
        debugPrint('ä»ç£ç›˜ç¼“å­˜åŠ è½½å›¾ç‰‡: $cacheKey');
        _addToByteCache(cacheKey, cachedBytes);
        return cachedBytes;
      }

      // ç”Ÿæˆä¼˜åŒ–åçš„å›¾ç‰‡
      final optimizedBytes = await _generateOptimizedImage(
        imagePath,
        width: width,
        height: height,
        quality: quality,
      );

      if (optimizedBytes != null) {
        // ä¿å­˜åˆ°ç¼“å­˜
        await _saveThumbnailCache(cacheKey, optimizedBytes);
        _addToByteCache(cacheKey, optimizedBytes);
        debugPrint('ç”Ÿæˆå¹¶ç¼“å­˜ä¼˜åŒ–å›¾ç‰‡: $cacheKey');
      }

      return optimizedBytes;
    } catch (e) {
      debugPrint('è·å–ä¼˜åŒ–å›¾ç‰‡å¤±è´¥: $e');
      return null;
    }
  }

  /// è·å–å†…å­˜ä¸­çš„UIå›¾ç‰‡å¯¹è±¡
  Future<ui.Image?> getUIImage(String imagePath) async {
    try {
      // æ£€æŸ¥å†…å­˜ç¼“å­˜
      if (_memoryCache.containsKey(imagePath)) {
        debugPrint('ä»å†…å­˜ç¼“å­˜åŠ è½½UIå›¾ç‰‡: $imagePath');
        return _memoryCache[imagePath];
      }

      // ä»æ–‡ä»¶åŠ è½½
      final file = File(imagePath);
      if (!await file.exists()) {
        return null;
      }

      final bytes = await file.readAsBytes();
      final codec = await ui.instantiateImageCodec(bytes);
      final frame = await codec.getNextFrame();
      final image = frame.image;

      // æ·»åŠ åˆ°å†…å­˜ç¼“å­˜
      _addToMemoryCache(imagePath, image);
      debugPrint('åŠ è½½å¹¶ç¼“å­˜UIå›¾ç‰‡: $imagePath');

      return image;
    } catch (e) {
      debugPrint('è·å–UIå›¾ç‰‡å¤±è´¥: $e');
      return null;
    }
  }

  /// é¢„åŠ è½½å›¾ç‰‡åˆ°ç¼“å­˜
  Future<void> preloadImage(String imagePath) async {
    try {
      // è·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼Œç¡®ä¿é¢„åŠ è½½çš„ç¼“å­˜é”®ä¸å®é™…ä½¿ç”¨æ—¶ä¸€è‡´
      DateTime? fileModifiedTime;
      try {
        final file = File(imagePath);
        if (await file.exists()) {
          final stat = await file.stat();
          fileModifiedTime = stat.modified;
          debugPrint('é¢„åŠ è½½æ—¶è·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´: $fileModifiedTime');
        }
      } catch (e) {
        debugPrint('é¢„åŠ è½½æ—¶è·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´å¤±è´¥: $e');
      }
      
      // é¢„åŠ è½½å¸¸ç”¨å°ºå¯¸çš„ç¼©ç•¥å›¾
      await Future.wait([
        getOptimizedImage(imagePath, width: 60, height: 80, fileModifiedTime: fileModifiedTime), // åˆ—è¡¨ç¼©ç•¥å›¾
        getOptimizedImage(imagePath, width: 120, height: 120, fileModifiedTime: fileModifiedTime), // å¯¹è¯æ¡†å›¾ç‰‡
        getOptimizedImage(imagePath, width: 200, height: 200, fileModifiedTime: fileModifiedTime), // è¯¦æƒ…é¡µå›¾ç‰‡
      ]);
      debugPrint('é¢„åŠ è½½å›¾ç‰‡å®Œæˆ: $imagePath');
    } catch (e) {
      debugPrint('é¢„åŠ è½½å›¾ç‰‡å¤±è´¥: $e');
    }
  }

  /// æ¸…ç†å•ä¸ªå›¾ç‰‡çš„ç¼“å­˜
  Future<void> clearImageCache(String imagePath) async {
    try {
      // ä»å†…å­˜ç¼“å­˜ç§»é™¤
      _memoryCache.remove(imagePath);

      // ä»å­—èŠ‚ç¼“å­˜ç§»é™¤ç›¸å…³é¡¹
      final keysToRemove = _byteCache.keys
          .where((key) => key.contains(imagePath.hashCode.toString()))
          .toList();

      for (final key in keysToRemove) {
        _byteCache.remove(key);
      }

      // ä»ç£ç›˜ç¼“å­˜ç§»é™¤ç›¸å…³æ–‡ä»¶
      if (_thumbnailCacheDir != null) {
        final cacheDir = Directory(_thumbnailCacheDir!);
        if (await cacheDir.exists()) {
          final files = await cacheDir.list().toList();
          for (final file in files) {
            if (file.path.contains(imagePath.hashCode.toString())) {
              await file.delete();
            }
          }
        }
      }

      debugPrint('æ¸…ç†å›¾ç‰‡ç¼“å­˜: $imagePath');
    } catch (e) {
      debugPrint('æ¸…ç†å›¾ç‰‡ç¼“å­˜å¤±è´¥: $e');
    }
  }

  /// æ¸…ç†æ‰€æœ‰ç¼“å­˜
  Future<void> clearAllCache() async {
    try {
      // æ¸…ç†å†…å­˜ç¼“å­˜
      _memoryCache.clear();
      _byteCache.clear();

      // æ¸…ç†ç£ç›˜ç¼“å­˜
      if (_thumbnailCacheDir != null) {
        final cacheDir = Directory(_thumbnailCacheDir!);
        if (await cacheDir.exists()) {
          await cacheDir.delete(recursive: true);
          await cacheDir.create(recursive: true);
        }
      }

      debugPrint('æ¸…ç†æ‰€æœ‰å›¾ç‰‡ç¼“å­˜');
    } catch (e) {
      debugPrint('æ¸…ç†æ‰€æœ‰ç¼“å­˜å¤±è´¥: $e');
    }
  }

  /// è·å–ç¼“å­˜çŠ¶æ€ä¿¡æ¯
  Map<String, dynamic> getCacheStatus() {
    return {
      'memoryCount': _memoryCache.length,
      'byteCount': _byteCache.length,
      'maxMemorySize': maxMemoryCacheSize,
      'maxByteSize': maxByteCacheSize,
      'thumbnailCacheDir': _thumbnailCacheDir,
    };
  }

  // ç§æœ‰æ–¹æ³•

  /// ç”Ÿæˆç¼“å­˜é”®
  String _generateCacheKey(
    String imagePath,
    int? width,
    int? height,
    int quality,
    DateTime? fileModifiedTime,
  ) {
    final timeStamp = fileModifiedTime?.millisecondsSinceEpoch ?? 'null';
    return '${imagePath.hashCode}_${width ?? 'null'}_${height ?? 'null'}_${quality}_$timeStamp';
  }

  /// ç”Ÿæˆä¼˜åŒ–åçš„å›¾ç‰‡
  Future<Uint8List?> _generateOptimizedImage(
    String imagePath, {
    int? width,
    int? height,
    int quality = 100,
  }) async {
    try {
      final file = File(imagePath);
      if (!await file.exists()) {
        return null;
      }

      final originalBytes = await file.readAsBytes();

      // å¦‚æœä¸éœ€è¦è°ƒæ•´å¤§å°ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®
      if (width == null && height == null) {
        return originalBytes;
      }

      // è§£ç å›¾ç‰‡
      final codec = await ui.instantiateImageCodec(originalBytes);
      final frame = await codec.getNextFrame();
      final originalImage = frame.image;

      // è®¡ç®—ç›®æ ‡å°ºå¯¸
      final targetWidth = width ?? originalImage.width;
      final targetHeight = height ?? originalImage.height;

      // å¦‚æœå°ºå¯¸ç›¸åŒï¼Œè¿”å›åŸå§‹æ•°æ®
      if (targetWidth == originalImage.width &&
          targetHeight == originalImage.height) {
        return originalBytes;
      }

      // åˆ›å»ºç”»å¸ƒå¹¶ç»˜åˆ¶ç¼©æ”¾åçš„å›¾ç‰‡
      final recorder = ui.PictureRecorder();
      final canvas = Canvas(recorder);

      final paint = Paint()
        ..isAntiAlias = true
        ..filterQuality = FilterQuality.high;

      canvas.drawImageRect(
        originalImage,
        Rect.fromLTWH(
          0,
          0,
          originalImage.width.toDouble(),
          originalImage.height.toDouble(),
        ),
        Rect.fromLTWH(0, 0, targetWidth.toDouble(), targetHeight.toDouble()),
        paint,
      );

      final picture = recorder.endRecording();
      final resizedImage = await picture.toImage(targetWidth, targetHeight);

      // è½¬æ¢ä¸ºå­—èŠ‚æ•°æ®
      final byteData = await resizedImage.toByteData(
        format: ui.ImageByteFormat.png,
      );

      originalImage.dispose();
      resizedImage.dispose();
      picture.dispose();

      return byteData?.buffer.asUint8List();
    } catch (e) {
      debugPrint('ç”Ÿæˆä¼˜åŒ–å›¾ç‰‡å¤±è´¥: $e');
      return null;
    }
  }

  /// ä»ç£ç›˜ç¼“å­˜è·å–ç¼©ç•¥å›¾
  Future<Uint8List?> _getCachedThumbnail(String cacheKey) async {
    try {
      if (_thumbnailCacheDir == null) return null;

      final cacheFile = File(path.join(_thumbnailCacheDir!, '$cacheKey.png'));
      if (await cacheFile.exists()) {
        return await cacheFile.readAsBytes();
      }
      return null;
    } catch (e) {
      debugPrint('è¯»å–ç£ç›˜ç¼“å­˜å¤±è´¥: $e');
      return null;
    }
  }

  /// ä¿å­˜ç¼©ç•¥å›¾åˆ°ç£ç›˜ç¼“å­˜
  Future<void> _saveThumbnailCache(String cacheKey, Uint8List bytes) async {
    try {
      if (_thumbnailCacheDir == null) return;

      final cacheFile = File(path.join(_thumbnailCacheDir!, '$cacheKey.png'));
      await cacheFile.writeAsBytes(bytes);
    } catch (e) {
      debugPrint('ä¿å­˜ç£ç›˜ç¼“å­˜å¤±è´¥: $e');
    }
  }

  /// æ·»åŠ åˆ°å†…å­˜ç¼“å­˜
  void _addToMemoryCache(String key, ui.Image image) {
    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œç§»é™¤æœ€æ—§çš„é¡¹
    if (_memoryCache.length >= maxMemoryCacheSize) {
      final firstKey = _memoryCache.keys.first;
      _memoryCache[firstKey]?.dispose();
      _memoryCache.remove(firstKey);
    }

    _memoryCache[key] = image;
  }

  /// æ·»åŠ åˆ°å­—èŠ‚ç¼“å­˜
  void _addToByteCache(String key, Uint8List bytes) {
    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œç§»é™¤æœ€æ—§çš„é¡¹
    if (_byteCache.length >= maxByteCacheSize) {
      final firstKey = _byteCache.keys.first;
      _byteCache.remove(firstKey);
    }

    _byteCache[key] = bytes;
  }

  /// é‡Šæ”¾èµ„æº
  void dispose() {
    // é‡Šæ”¾å†…å­˜ä¸­çš„UIå›¾ç‰‡
    for (final image in _memoryCache.values) {
      image.dispose();
    }
    _memoryCache.clear();
    _byteCache.clear();
  }
}


// ============================================================
// æ–‡ä»¶: core\database\database.dart
// ============================================================
import 'package:drift/drift.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:drift/native.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;
import 'dart:io';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'products_table.dart';
import 'categories_table.dart';
import 'units_table.dart';
import 'product_units_table.dart';
import 'shops_table.dart';
import 'suppliers_table.dart';
import 'batches_table.dart';
import 'inventory_table.dart';
import 'inventory_transactions_table.dart';
import 'locations_table.dart';
import 'inbound_receipts_table.dart';
import 'inbound_receipt_items_table.dart';
import 'purchase_orders_table.dart';
import 'purchase_order_items_table.dart';
import 'barcodes_table.dart'; // æ–°å¢æ¡ç è¡¨
import 'customers_table.dart';
import 'sales_transactions_table.dart';
import 'sales_transaction_items_table.dart';
import 'outbound_receipts_table.dart';
import 'outbound_receipt_items_table.dart';
import '../../features/product/data/dao/product_dao.dart';
import '../../features/product/data/dao/category_dao.dart';
import '../../features/product/data/dao/unit_dao.dart';
import '../../features/product/data/dao/product_unit_dao.dart';
import '../../features/purchase/data/dao/supplier_dao.dart';
import '../../features/product/data/dao/batch_dao.dart';
import '../../features/inventory/data/dao/shop_dao.dart';
import '../../features/inventory/data/dao/inventory_dao.dart';
import '../../features/inventory/data/dao/inventory_transaction_dao.dart';
import '../../features/inbound/data/dao/location_dao.dart';
import '../../features/inbound/data/dao/inbound_receipt_dao.dart';
import '../../features/inbound/data/dao/inbound_item_dao.dart';
import '../../features/purchase/data/dao/purchase_dao.dart';
import '../../features/product/data/dao/barcode_dao.dart';
import '../../features/sale/data/dao/customer_dao.dart';
import '../../features/sale/data/dao/sales_transaction_dao.dart';
import '../../features/sale/data/dao/sales_transaction_item_dao.dart';
import '../../features/outbound/data/dao/outbound_receipt_dao.dart';
import '../../features/outbound/data/dao/outbound_item_dao.dart';
import '../../features/product/domain/model/product.dart';

part 'database.g.dart';

@DriftDatabase(
  tables: [
    Product,
    Category,
    Unit,
    UnitProduct,
    Shop,
    Supplier,
    ProductBatch,
    Stock,
    InventoryTransaction,
    LocationsTable,
    InboundReceipt,
    InboundItem,
    PurchaseOrder,
    PurchaseOrderItem,
    Barcode, // æ–°å¢æ¡ç è¡¨
    Customers,
    SalesTransaction,
    SalesTransactionItem,
    OutboundReceipt,
    OutboundItem,
  ],
  daos: [
    ProductDao,
    CategoryDao,
    UnitDao,
    ProductUnitDao,
    ShopDao,
    SupplierDao,
    BatchDao,
    InventoryDao,
    InventoryTransactionDao,
    LocationDao,
    InboundReceiptDao,
    InboundItemDao,
    PurchaseDao,
    BarcodeDao, // æ–°å¢æ¡ç DAO
    CustomerDao,
    SalesTransactionDao,
    SalesTransactionItemDao,
    OutboundReceiptDao,
    OutboundItemDao,
  ],
)
class AppDatabase extends _$AppDatabase {
  AppDatabase(super.e);
  @override
  int get schemaVersion => 22; 

  @override
  MigrationStrategy get migration => MigrationStrategy(
    onCreate: (Migrator m) async {
      await m.createAll();
      // åˆ›å»ºæ¡ç è¡¨çš„æ¡ç å€¼ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_barcode_barcode_value ON barcode(barcode_value);',
      );
      // åˆ›å»ºæ¡ç è¡¨çš„äº§å“å•ä½IDç´¢å¼•
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_barcode_unit_product_id ON barcode(unit_product_id);',
      );
      // é‡‡è´­å•ç›¸å…³ç´¢å¼•
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_po_supplier ON purchase_order(supplier_id);',
      );
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_po_shop ON purchase_order(shop_id);',
      );
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_po_status ON purchase_order(status);',
      );
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_po_created ON purchase_order(created_at);',
      );
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_poi_po ON purchase_order_item(purchase_order_id);',
      );
      await customStatement(
        'CREATE INDEX IF NOT EXISTS idx_poi_product ON purchase_order_item(product_id);',
      );
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS poi_unique_with_date ON purchase_order_item(purchase_order_id, product_id, production_date) WHERE production_date IS NOT NULL;',
      );
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS poi_unique_without_date ON purchase_order_item(purchase_order_id, product_id) WHERE production_date IS NULL;',
      );
      // ä¸ºåº“å­˜è¡¨åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS stock_unique_with_batch ON stock(product_id, shop_id, batch_id) WHERE batch_id IS NOT NULL;',
      );
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS stock_unique_without_batch ON stock(product_id, shop_id) WHERE batch_id IS NULL;',
      );
      // ä¸ºå…¥åº“å•æ˜ç»†è¡¨åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS inbound_item_unique_with_batch ON inbound_item(receipt_id, product_id, batch_id) WHERE batch_id IS NOT NULL;',
      );
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS inbound_item_unique_without_batch ON inbound_item(receipt_id, product_id) WHERE batch_id IS NULL;',
      );
      // ä¸ºå‡ºåº“å•æ˜ç»†è¡¨åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS outbound_item_unique_with_batch ON outbound_item(receipt_id, product_id, batch_id) WHERE batch_id IS NOT NULL;',
      );
      await customStatement(
        'CREATE UNIQUE INDEX IF NOT EXISTS outbound_item_unique_without_batch ON outbound_item(receipt_id, product_id) WHERE batch_id IS NULL;',
      );
    },
    onUpgrade: (Migrator m, int from, int to) async {
      
      if (from < 22 && to >= 22) {
        // æ·»åŠ ç§»åŠ¨åŠ æƒå¹³å‡ä»·æ ¼å­—æ®µ
        await m.addColumn(stock, stock.averageUnitPriceInCents);
        // æ·»åŠ å…¥åº“å•æ˜ç»†è¡¨å•ä»·å­—æ®µ
        // await m.addColumn(inboundItem, inboundItem.unitPriceInCents);
      }
      if (from < 21 && to >= 21) {
        // åˆ é™¤æ—§çš„å”¯ä¸€ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        await customStatement('DROP INDEX IF EXISTS poi_unique_line;');
        // åˆ›å»ºæ–°çš„æ¡ä»¶å”¯ä¸€ç´¢å¼•
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS poi_unique_with_date ON purchase_order_item(purchase_order_id, product_id, production_date) WHERE production_date IS NOT NULL;',
        );
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS poi_unique_without_date ON purchase_order_item(purchase_order_id, product_id) WHERE production_date IS NULL;',
        );

        // ä¸ºåº“å­˜è¡¨åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼ˆä¸ onCreate ä¿æŒä¸€è‡´ï¼Œç¡®ä¿è€ç‰ˆæœ¬å‡çº§åä¹Ÿå…·å¤‡çº¦æŸï¼‰
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS stock_unique_with_batch ON stock(product_id, shop_id, batch_id) WHERE batch_id IS NOT NULL;',
        );
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS stock_unique_without_batch ON stock(product_id, shop_id) WHERE batch_id IS NULL;',
        );

        // ä¸ºå‡ºåº“å•æ˜ç»†è¡¨åˆ›å»ºéƒ¨åˆ†å”¯ä¸€ç´¢å¼•
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS outbound_item_unique_with_batch ON outbound_item(receipt_id, product_id, batch_id) WHERE batch_id IS NOT NULL;',
        );
        await customStatement(
          'CREATE UNIQUE INDEX IF NOT EXISTS outbound_item_unique_without_batch ON outbound_item(receipt_id, product_id) WHERE batch_id IS NULL;',
        );
      }
      if (from < 20 && to >= 20) {
        await m.createTable(outboundReceipt);
        await m.createTable(outboundItem);
      }
      if (from < 17 && to >= 17) {
        await m.createTable(salesTransaction);
        await m.createTable(salesTransactionItem);
      }
      if (from < 19 && to >= 19) {
        // æ–°å¢é‡‡è´­å•/æ˜ç»†ç´¢å¼•ä¸å”¯ä¸€ç´¢å¼•
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_po_supplier ON purchase_order(supplier_id);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_po_shop ON purchase_order(shop_id);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_po_status ON purchase_order(status);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_po_created ON purchase_order(created_at);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_poi_po ON purchase_order_item(purchase_order_id);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_poi_product ON purchase_order_item(product_id);',
        );
        // This is now handled by the migration to version 21
      }
      if (from < 18 && to >= 18) {
        // ä¸º sales_transaction_items è¡¨çš„ unit_id åˆ—æ·»åŠ æ˜ç¡®çš„åˆ—å
        // ç”±äºæˆ‘ä»¬å·²ç»ä¿®æ”¹äº†è¡¨ç»“æ„ï¼Œéœ€è¦é‡æ–°åˆ›å»ºè¡¨
        await m.createTable(salesTransactionItem);
      }
      if (from < 16 && to >= 16) {
        await m.createTable(customers);
      }
      if (from < 15 && to >= 15) {
        await m.addColumn(inboundReceipt, inboundReceipt.source);
      }
      if (from < 14 && to >= 14) {
        await m.deleteTable('purchases');
        await m.createTable(purchaseOrder);
        await m.createTable(purchaseOrderItem);
      }
      if (from < 13 && to >= 13) {
        // ä¸º product_units è¡¨æ·»åŠ  wholesale_price åˆ—
        await m.addColumn(unitProduct, unitProduct.wholesalePriceInCents);
      }
      if (from < 12 && to >= 12) {
        // é‡å»ºé‡‡è´­è¡¨ä»¥ä½¿ production_date åˆ—å¯ä¸ºç©º
        // This migration is now obsolete as purchasesTable is removed.
        // The logic is replaced by migration to version 14.
      }
      if (from < 11 && to >= 11) {
        // æ·»åŠ æ¡ç è¡¨
        await m.createTable(barcode);
        // åˆ›å»ºæ¡ç è¡¨çš„ç´¢å¼•
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_barcode_barcode_value ON barcode(barcode_value);',
        );
        await customStatement(
          'CREATE INDEX IF NOT EXISTS idx_barcode_unit_product_id ON barcode(unit_product_id);',
        );
      }
      
      if (from < 8 && to >= 8) {
        // This migration is now obsolete as purchasesTable is removed.
        // The logic is replaced by migration to version 14.
      }
      if (from == 1 && to == 2) {
        // ä»ç‰ˆæœ¬1å‡çº§åˆ°ç‰ˆæœ¬2ï¼šä¿®æ”¹äº§å“è¡¨çš„IDåˆ—ä¸ºéç©º
        // ç”±äºSQLiteä¸æ”¯æŒç›´æ¥ä¿®æ”¹åˆ—çš„nullçº¦æŸï¼Œæˆ‘ä»¬éœ€è¦é‡å»ºè¡¨
        await m.recreateAllViews();
      }
      if (from == 2 && to == 3) {
        // ä»ç‰ˆæœ¬2å‡çº§åˆ°ç‰ˆæœ¬3ï¼šæ·»åŠ ç±»åˆ«è¡¨
        await m.createTable(category);
      }
      if (from == 3 && to == 4) {
        // ä»ç‰ˆæœ¬3å‡çº§åˆ°ç‰ˆæœ¬4ï¼šæ·»åŠ å•ä½è¡¨
        await m.createTable(unit);
      }
      if (from == 4 && to == 5) {
        // ä»ç‰ˆæœ¬4å‡çº§åˆ°ç‰ˆæœ¬5ï¼šæ·»åŠ äº§å“å•ä½è¡¨
        await m.createTable(unitProduct);
      }
      if (from == 5 && to == 6) {
        // ä»ç‰ˆæœ¬5å‡çº§åˆ°ç‰ˆæœ¬6ï¼šæ·»åŠ åº—é“ºè¡¨
        await m.createTable(shop);
      }
      if (from == 6 && to == 7) {
        // ä»ç‰ˆæœ¬6å‡çº§åˆ°ç‰ˆæœ¬7ï¼šæ·»åŠ æ‰€æœ‰ç¼ºå¤±çš„è¡¨
        await m.createTable(supplier);
        await m.createTable(productBatch);
        await m.createTable(stock);
        await m.createTable(inventoryTransaction);
        await m.createTable(locationsTable);
        await m.createTable(inboundReceipt);
        await m.createTable(inboundItem);
      }
      // å¤„ç†ä»æ—§ç‰ˆæœ¬ç›´æ¥å‡çº§åˆ°ç‰ˆæœ¬7çš„æƒ…å†µ
      if (from < 7 && to == 7) {
        // ç¡®ä¿æ‰€æœ‰è¡¨éƒ½å­˜åœ¨
        if (from < 3) await m.createTable(category);
        if (from < 4) await m.createTable(unit);
        if (from < 5) await m.createTable(unitProduct);
        if (from < 6) await m.createTable(shop);
        await m.createTable(supplier);
        await m.createTable(productBatch);
        await m.createTable(stock);
        await m.createTable(inventoryTransaction);
        await m.createTable(locationsTable);
        await m.createTable(inboundReceipt);
        await m.createTable(inboundItem);
      }
      // ä¿ç•™åŸæœ‰çš„è¿ç§»é€»è¾‘
      if (from == 1 && to == 3) {
        // ä»ç‰ˆæœ¬1ç›´æ¥å‡çº§åˆ°ç‰ˆæœ¬3
        await m.recreateAllViews();
        await m.createTable(category);
      }
      if (from == 1 && to == 4) {
        // ä»ç‰ˆæœ¬1ç›´æ¥å‡çº§åˆ°ç‰ˆæœ¬4
        await m.recreateAllViews();
        await m.createTable(category);
        await m.createTable(unit);
      }
      if (from == 1 && to == 5) {
        // ä»ç‰ˆæœ¬1ç›´æ¥å‡çº§åˆ°ç‰ˆæœ¬5
        await m.recreateAllViews();
        await m.createTable(category);
        await m.createTable(unit);
        await m.createTable(unitProduct);
      }
      if (from == 2 && to == 4) {
        // ä»ç‰ˆæœ¬2ç›´æ¥å‡çº§åˆ°ç‰ˆæœ¬4
        await m.createTable(category);
        await m.createTable(unit);
      }
      if (from == 2 && to == 5) {
        // ä»ç‰ˆæœ¬2å‡çº§åˆ°ç‰ˆæœ¬5
        await m.createTable(category);
        await m.createTable(unit);
        await m.createTable(unitProduct);
      }
      if (from == 3 && to == 5) {
        // ä»ç‰ˆæœ¬3å‡çº§åˆ°ç‰ˆæœ¬5
        await m.createTable(unit);
        await m.createTable(unitProduct);
      }
      // åœ¨ä»»ä½•ç‰ˆæœ¬å‡çº§åéƒ½ç¡®ä¿æ¡ç è¡¨ç´¢å¼•å­˜åœ¨ï¼ˆç§»é™¤äº†äº§å“è¡¨æ¡ç ç´¢å¼•ï¼Œå› ä¸ºäº§å“è¡¨å·²æ— æ¡ç å­—æ®µï¼‰
      // æ³¨é‡Šæ‰ï¼šäº§å“è¡¨å·²æ— æ¡ç å­—æ®µ
      // await customStatement(
      //   'CREATE INDEX IF NOT EXISTS idx_products_barcode ON products(barcode);',
      // );
    },
  );
}

@riverpod
AppDatabase appDatabase(Ref ref) {
  return AppDatabase(_openConnection());
}

QueryExecutor _openConnection() {
  // Use LazyDatabase with NativeDatabase for native platforms (mobile & desktop)
  return LazyDatabase(() async {
    final dbFolder = await getApplicationDocumentsDirectory();
    final file = File(p.join(dbFolder.path, 'app_database.db'));
    return NativeDatabase(file);
  });
}


// ============================================================
// æ–‡ä»¶: core\router\router_provider.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../constants/app_routes.dart';
import '../widgets/scaffold_with_nav_bar.dart';
import '../widgets/privacy_policy_checker.dart';
import '../../features/product/presentation/screens/product_list_screen.dart';
import '../../features/product/presentation/screens/product_add_edit_screen.dart';
import '../../features/product/presentation/screens/product_detail_screen.dart';
import '../../features/product/presentation/screens/product_ranking_screen.dart';
import '../../features/product/presentation/screens/category_selection_screen.dart';
import '../../features/product/application/provider/product_providers.dart';
import '../../features/database/presentation/screens/database_viewer_screen.dart';
import '../../features/debug/screens/database_management_screen.dart';
import '../../features/inbound/presentation/screens/screens.dart';
import '../../features/inventory/presentation/screens/screens.dart';
import '../../features/sale/presentation/screens/create_sale_screen.dart';
import '../../features/sale/presentation/screens/sales_records_screen.dart';
import '../../features/purchase/presentation/screens/purchase_records_screen.dart';
import '../../features/settings/presentation/screens/settings_screen.dart';
import '../../features/settings/presentation/screens/terms_of_service_screen.dart';
import '../../features/settings/presentation/screens/privacy_policy_screen.dart';
import '../../features/sale/presentation/screens/customer_selection_screen.dart';
import '../../features/home/presentation/screens/home_screen.dart';
import '../../core/models/scanned_product_payload.dart';
import '../../debug/product_restore_debug_page.dart';

// GoRouter Provider
final routerProvider = Provider<GoRouter>((ref) {
  return GoRouter(
    initialLocation: AppRoutes.home,
    routes: [
      // åº•éƒ¨å¯¼èˆªæ æ‰¿è½½çš„ 4 ä¸ªä¸»åˆ†æ”¯
      StatefulShellRoute.indexedStack(
        builder: (context, state, navigationShell) => PrivacyPolicyChecker(
          child: ScaffoldWithNavBar(navigationShell: navigationShell),
        ),
        branches: [
          // é¦–é¡µ
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.home,
                name: 'home',
                builder: (context, state) => const HomeScreen(),
              ),
            ],
          ),
          // è´§å“
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.products,
                name: 'products',
                builder: (context, state) => const ProductListScreen(),
                routes: [
                  GoRoute(
                    path: 'ranking',
                    name: 'product-ranking',
                    builder: (context, state) => const ProductRankingScreen(),
                  ),
                  GoRoute(
                    path: ':id',
                    name: 'product-detail',
                    builder: (context, state) {
                      final productId = int.parse(state.pathParameters['id']!);
                      return ProductDetailScreen(productId: productId);
                    },
                  ),
                ],
              ),
            ],
          ),
          // é”€å”®
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.sales,
                name: 'sales',
                builder: (context, state) => Scaffold(
                  appBar: AppBar(title: const Text('é”€å”®ç®¡ç†')),
                  body: Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text(
                          'é”€å”®ç®¡ç†åŠŸèƒ½',
                          style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 40),
                        SizedBox(
                          width: 200,
                          child: ElevatedButton(
                            onPressed: () => context.push(AppRoutes.saleCreate),
                            child: const Text('æ–°å»ºé”€å”®å•'),
                          ),
                        ),
                        const SizedBox(height: 16),
                        SizedBox(
                          width: 200,
                          child: ElevatedButton(
                            onPressed: () =>
                                context.push(AppRoutes.saleRecords),
                            child: const Text('é”€å”®è®°å½•'),
                          ),
                        ),
                        const SizedBox(height: 20),
                        ElevatedButton(
                          onPressed: () => context.go(AppRoutes.home),
                          child: const Text('è¿”å›é¦–é¡µ'),
                        ),
                      ],
                    ),
                  ),
                ),
                routes: [
                  GoRoute(
                    path: 'records',
                    name: 'sale-records',
                    builder: (context, state) => const SalesRecordsScreen(),
                  ),
                ],
              ),
            ],
          ),
          // åº“å­˜
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.inventory,
                name: 'inventory',
                builder: (context, state) => Scaffold(
                  appBar: AppBar(title: const Text('åº“å­˜ç®¡ç†')),
                  body: Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text(
                          'åº“å­˜ç®¡ç†åŠŸèƒ½',
                          style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 40),


////////////////////////////////////////////////////////////////////////////////
å 30 é¡µ (ç¬¬ 56278 - 57777 è¡Œ)
////////////////////////////////////////////////////////////////////////////////

          },
        );
      },
    );
    
    // å¦‚æœç”¨æˆ·ç‚¹å‡»"ä¸åŒæ„"ï¼Œé€€å‡ºåº”ç”¨
    if (result == false) {
      SystemNavigator.pop();
    }
  }

  @override
  Widget build(BuildContext context) {
    return widget.child;
  }
}

// ============================================================
// æ–‡ä»¶: features\product\presentation\controllers\product_form_controllers.dart
// ============================================================
import 'package:flutter/material.dart';

import '../../domain/model/product.dart';

/// è´Ÿè´£ç®¡ç† Product è¡¨å•çš„ TextEditingController ä¸ FocusNodeã€‚
/// å°†åˆå§‹åŒ–/å›å¡«ä¸èµ„æºé‡Šæ”¾ä»é¡µé¢ä¸­æŠ½ç¦»ï¼Œé¡µé¢åªåš UI ç»„è£…ä¸äº‹ä»¶è½¬å‘ã€‚
class ProductFormControllers {
  // æ–‡æœ¬æ§åˆ¶å™¨
  final TextEditingController categoryController = TextEditingController();
  final TextEditingController unitController = TextEditingController();
  late final TextEditingController nameController;
  late final TextEditingController barcodeController;
  late final TextEditingController retailPriceController;
  late final TextEditingController promotionalPriceController;
  late final TextEditingController suggestedRetailPriceController;
  late final TextEditingController stockWarningValueController;
  late final TextEditingController shelfLifeController;
  late final TextEditingController remarksController;

  // ç„¦ç‚¹èŠ‚ç‚¹
  final FocusNode nameFocusNode = FocusNode();
  final FocusNode unitFocusNode = FocusNode();
  final FocusNode categoryFocusNode = FocusNode();
  final FocusNode retailPriceFocusNode = FocusNode();
  final FocusNode shelfLifeFocusNode = FocusNode();
  final FocusNode stockWarningValueFocusNode = FocusNode();

  /// æ ¹æ®ä¼ å…¥çš„ [product] åˆå§‹åŒ–å„è¾“å…¥æ¡†ï¼Œç©ºå€¼ä½¿ç”¨é¡µé¢é»˜è®¤å€¼ä¿æŒä¸€è‡´ã€‚
  void init(ProductModel? product) {
    nameController = TextEditingController(text: product?.name ?? '');
    barcodeController = TextEditingController(text: ''); // æ¡ç å¼‚æ­¥åŠ è½½

    retailPriceController = TextEditingController(
      text: product?.retailPrice != null
          ? product!.retailPrice!.yuan.toStringAsFixed(2)
          : '',
    );

    promotionalPriceController = TextEditingController(
      text: product?.promotionalPrice != null
          ? product!.promotionalPrice!.yuan.toStringAsFixed(2)
          : '',
    );

    suggestedRetailPriceController = TextEditingController(
      text: product?.suggestedRetailPrice != null
          ? product!.suggestedRetailPrice!.yuan.toStringAsFixed(2)
          : '',
    );

    stockWarningValueController = TextEditingController(
      text: product?.stockWarningValue?.toString() ?? '',
    );

    shelfLifeController = TextEditingController(
      text: product?.shelfLife?.toString() ?? '',
    );

    remarksController = TextEditingController(text: product?.remarks ?? '');

    // categoryController ä¸ unitController åˆå§‹æ–‡æœ¬ç”±é¡µé¢é€‰æ‹©é€»è¾‘/å›å¡«å†³å®š
  }

  void dispose() {
    // æ–‡æœ¬æ§åˆ¶å™¨
    nameController.dispose();
    barcodeController.dispose();
    retailPriceController.dispose();
    promotionalPriceController.dispose();
    suggestedRetailPriceController.dispose();
    stockWarningValueController.dispose();
    shelfLifeController.dispose();
    remarksController.dispose();
    categoryController.dispose();
    unitController.dispose();

    // ç„¦ç‚¹èŠ‚ç‚¹
    nameFocusNode.dispose();
    unitFocusNode.dispose();
    categoryFocusNode.dispose();
    retailPriceFocusNode.dispose();
    shelfLifeFocusNode.dispose();
    stockWarningValueFocusNode.dispose();
  }
}


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\sections\unit_category_section.dart
// ============================================================
import 'package:flutter/material.dart';
import '../../../domain/model/unit.dart';
import '../../../domain/model/category.dart';
import '../inputs/unit_typeahead_field.dart';
import '../inputs/category_typeahead_field.dart';

/// å•ä½ + ç±»åˆ«ç»„åˆåŒºåŸŸ
class UnitCategorySection extends StatelessWidget {
  final TextEditingController unitController;
  final FocusNode unitFocusNode;
  final List<Unit> units;
  final int? selectedUnitId;
  final ValueChanged<Unit> onUnitSelected;
  final VoidCallback onTapAddAuxiliary;
  final VoidCallback onTapChooseUnit;
  final String? Function() errorTextBuilder;
  final String? helperText;
  final VoidCallback onUnitClear;
  final VoidCallback onUnitSubmitted;

  final TextEditingController categoryController;
  final FocusNode categoryFocusNode;
  final List<CategoryModel> categories;
  final int? selectedCategoryId;
  final ValueChanged<CategoryModel> onCategorySelected;
  final VoidCallback onTapChooseCategory;
  final VoidCallback onCategoryClear;
  final VoidCallback onCategorySubmitted;

  const UnitCategorySection({
    super.key,
    required this.unitController,
    required this.unitFocusNode,
    required this.units,
    required this.selectedUnitId,
    required this.onUnitSelected,
    required this.onTapAddAuxiliary,
    required this.onTapChooseUnit,
    required this.errorTextBuilder,
    required this.helperText,
    required this.onUnitClear,
    required this.onUnitSubmitted,
    required this.categoryController,
    required this.categoryFocusNode,
    required this.categories,
    required this.selectedCategoryId,
    required this.onCategorySelected,
    required this.onTapChooseCategory,
    required this.onCategoryClear,
    required this.onCategorySubmitted,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        UnitTypeAheadField(
          controller: unitController,
          focusNode: unitFocusNode,
          units: units,
          selectedUnitId: selectedUnitId,
          onSelected: onUnitSelected,
          onTapAddAuxiliary: onTapAddAuxiliary,
          onTapChooseUnit: onTapChooseUnit,
          errorTextBuilder: errorTextBuilder,
          helperText: helperText,
          onClear: onUnitClear,
          onSubmitted: onUnitSubmitted,
        ),
        const SizedBox(height: 16),
        CategoryTypeAheadField(
          controller: categoryController,
          focusNode: categoryFocusNode,
          categories: categories,
          selectedCategoryId: selectedCategoryId,
          onSelected: onCategorySelected,
          onTapChooseCategory: onTapChooseCategory,
          onClear: onCategoryClear,
          onSubmitted: onCategorySubmitted,
        ),
      ],
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\debug\measured_container.dart
// ============================================================
import 'package:flutter/material.dart';

/// å¯æµ‹é‡é«˜åº¦çš„å®¹å™¨ç»„ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
/// åœ¨çº¢è‰²è¾¹æ¡†çš„å³ä¸Šè§’æ˜¾ç¤ºå®¹å™¨å†…å®¹çš„é«˜åº¦
class MeasuredContainer extends StatefulWidget {
  final Widget child;
  final EdgeInsetsGeometry? padding;
  final String? label; // å¯é€‰æ ‡ç­¾ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å®¹å™¨

  const MeasuredContainer({
    super.key,
    required this.child,
    this.padding,
    this.label,
  });

  @override
  State<MeasuredContainer> createState() => _MeasuredContainerState();
}

class _MeasuredContainerState extends State<MeasuredContainer> {
  final GlobalKey _containerKey = GlobalKey();
  double? _height;

  @override
  void initState() {
    super.initState();
    // åœ¨é¦–å¸§æ¸²æŸ“åæµ‹é‡é«˜åº¦
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _measureHeight();
    });
  }

  void _measureHeight() {
    final RenderBox? renderBox =
        _containerKey.currentContext?.findRenderObject() as RenderBox?;
    if (renderBox != null && mounted) {
      setState(() {
        _height = renderBox.size.height;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Stack(
      clipBehavior: Clip.none,
      children: [
        Container(
          key: _containerKey,
          padding:
              widget.padding ??
              const EdgeInsets.symmetric(horizontal: 0, vertical: 0),
          child: widget.child,
        ),
        // æ˜¾ç¤ºé«˜åº¦æ ‡ç­¾
        if (_height != null)
          Positioned(
            top: -10,
            right: 8,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 0),
              decoration: BoxDecoration(
                color: Colors.red,
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                widget.label != null
                    ? '${widget.label}: ${_height!.toStringAsFixed(1)}px'
                    : '${_height!.toStringAsFixed(1)}px',
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
      ],
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\backup\presentation\widgets\backup_frequency_selector.dart
// ============================================================
import 'package:flutter/material.dart';

import '../../domain/models/auto_backup_settings.dart';

/// å¤‡ä»½é¢‘ç‡é€‰æ‹©å™¨
class BackupFrequencySelector extends StatelessWidget {
  final BackupFrequency currentFrequency;
  final ValueChanged<BackupFrequency> onFrequencyChanged;

  const BackupFrequencySelector({
    super.key,
    required this.currentFrequency,
    required this.onFrequencyChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(
                  Icons.schedule,
                  color: Theme.of(context).colorScheme.primary,
                ),
                const SizedBox(width: 8),
                Text(
                  'å¤‡ä»½é¢‘ç‡',
                  style: Theme.of(context).textTheme.titleMedium,
                ),
              ],
            ),
            const SizedBox(height: 16),
            Column(
              children: BackupFrequency.values.map((frequency) {
                return RadioListTile<BackupFrequency>(
                  title: Text(_getFrequencyTitle(frequency)),
                  subtitle: Text(_getFrequencyDescription(frequency)),
                  value: frequency,
                  groupValue: currentFrequency,
                  onChanged: (value) {
                    if (value != null) {
                      onFrequencyChanged(value);
                    }
                  },
                );
              }).toList(),
            ),
          ],
        ),
      ),
    );
  }

  String _getFrequencyTitle(BackupFrequency frequency) {
    switch (frequency) {
      case BackupFrequency.daily:
        return 'æ¯æ—¥å¤‡ä»½';
      case BackupFrequency.weekly:
        return 'æ¯å‘¨å¤‡ä»½';
      case BackupFrequency.monthly:
        return 'æ¯æœˆå¤‡ä»½';
    }
  }

  String _getFrequencyDescription(BackupFrequency frequency) {
    switch (frequency) {
      case BackupFrequency.daily:
        return 'æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½';
      case BackupFrequency.weekly:
        return 'æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½';
      case BackupFrequency.monthly:
        return 'æ¯æœˆ1å·å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½';
    }
  }
}

// ============================================================
// æ–‡ä»¶: features\inventory\presentation\widgets\debug_inventory_detail.dart
// ============================================================
import 'package:flutter/material.dart';
import '../../domain/model/aggregated_inventory.dart';

/// è°ƒè¯•ç”¨ï¼šæ˜¾ç¤ºåº“å­˜è¯¦ç»†ä¿¡æ¯çš„åŸå§‹æ•°æ®
class DebugInventoryDetail extends StatelessWidget {
  final InventoryDetail detail;

  const DebugInventoryDetail({super.key, required this.detail});

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: const EdgeInsets.all(8),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'è°ƒè¯•ä¿¡æ¯',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.red,
              ),
            ),
            const Divider(),
            _buildRow('åº—é“ºåç§°', detail.shopName),
            _buildRow('ç”Ÿäº§æ—¥æœŸ', detail.productionDate?.toString() ?? 'null'),
            _buildRow('ä¿è´¨æœŸæ•°å€¼', detail.shelfLifeDays?.toString() ?? 'null'),
            _buildRow('ä¿è´¨æœŸå•ä½', detail.shelfLifeUnit ?? 'null'),
            _buildRow('è®¡ç®—çš„å‰©ä½™å¤©æ•°', detail.remainingDays?.toString() ?? 'null'),
            _buildRow('æ˜¾ç¤ºæ–‡æœ¬', detail.remainingDaysDisplayText),
            const Divider(),
            Text(
              'å¦‚æœæ˜¾ç¤ºä¸å¯¹ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…å€¼',
              style: TextStyle(
                fontSize: 12,
                color: Colors.grey[600],
                fontStyle: FontStyle.italic,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 120,
            child: Text(
              '$label:',
              style: const TextStyle(
                fontWeight: FontWeight.w600,
                fontSize: 14,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(fontSize: 14),
            ),
          ),
        ],
      ),
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\inputs\shelf_life_unit_dropdown.dart
// ============================================================
import 'package:dropdown_button2/dropdown_button2.dart';
import 'package:flutter/material.dart';

/// ä¿è´¨æœŸå•ä½ä¸‹æ‹‰
class ShelfLifeUnitDropdown extends StatelessWidget {
  final String value;
  final List<String> options;
  final ValueChanged<String> onChanged;

  const ShelfLifeUnitDropdown({
    super.key,
    required this.value,
    required this.options,
    required this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Align(
      alignment: Alignment.centerLeft,
      child: SizedBox(
        height: 48,
        child: IntrinsicWidth(
          child: DropdownButtonFormField2<String>(
            value: value,
            decoration: InputDecoration(
              contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
              filled: false,
              border: InputBorder.none,
              enabledBorder: InputBorder.none,
              focusedBorder: InputBorder.none,
              hintStyle: Theme.of(context).inputDecorationTheme.hintStyle,
            ),
            items: options.map((unit) {
              return DropdownMenuItem(
                value: unit,
                child: Text(
                  _displayName(unit),
                  style: Theme.of(context).textTheme.bodyLarge,
                ),
              );
            }).toList(),
            onChanged: (val) {
              if (val != null) onChanged(val);
            },
            buttonStyleData: const ButtonStyleData(
              padding: EdgeInsets.only(right: 4),
            ),
            iconStyleData: const IconStyleData(
              icon: Icon(Icons.arrow_drop_down),
              iconSize: 24,
            ),
            dropdownStyleData: DropdownStyleData(
              maxHeight: 200,
              decoration: BoxDecoration(borderRadius: BorderRadius.circular(12)),
            ),
          ),
        ),
      ),
    );
  }

  String _displayName(String unit) {
    switch (unit) {
      case 'days':
        return 'å¤©';
      case 'months':
        return 'ä¸ªæœˆ';
      case 'years':
        return 'å¹´';
      default:
        return unit;
    }
  }
}


// ============================================================
// æ–‡ä»¶: core\shared_widgets\loading_widget.dart
// ============================================================
import 'package:flutter/material.dart';

class LoadingWidget extends StatelessWidget {
  final String? message;
  final double size;
  final Color? color;
  final bool showMessage;

  const LoadingWidget({
    super.key,
    this.message,
    this.size = 40.0,
    this.color,
    this.showMessage = true,
  });

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          SizedBox(
            width: size,
            height: size,
            child: CircularProgressIndicator(
              color: color ?? Theme.of(context).primaryColor,
              strokeWidth: 3.0,
            ),
          ),
          if (showMessage && message != null) ...[
            const SizedBox(height: 16),
            Text(
              message!,
              style: Theme.of(
                context,
              ).textTheme.bodyMedium?.copyWith(color: Colors.grey[600]),
              textAlign: TextAlign.center,
            ),
          ],
        ],
      ),
    );
  }
}

class LoadingOverlay extends StatelessWidget {
  final Widget child;
  final bool isLoading;
  final String? loadingMessage;

  const LoadingOverlay({
    super.key,
    required this.child,
    required this.isLoading,
    this.loadingMessage,
  });

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        child,
        if (isLoading)
          Container(
            color: Colors.black.withOpacity(0.3),
            child: LoadingWidget(message: loadingMessage ?? 'åŠ è½½ä¸­...'),
          ),
      ],
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\sections\basic_info_section.dart
// ============================================================
import 'package:flutter/material.dart';
import '../product_image_picker.dart';
import '../inputs/app_text_field.dart';
import 'barcode_section.dart';

/// åŸºç¡€ä¿¡æ¯åŒºï¼šå›¾ç‰‡ã€åç§°ã€æ¡ç 
class BasicInfoSection extends StatelessWidget {
  final String? initialImagePath;
  final ValueChanged<String?> onImageChanged;

  final TextEditingController nameController;
  final FocusNode nameFocusNode;
  final VoidCallback onNameSubmitted;

  final TextEditingController barcodeController;
  final VoidCallback onScan;

  const BasicInfoSection({
    super.key,
    required this.initialImagePath,
    required this.onImageChanged,
    required this.nameController,
    required this.nameFocusNode,
    required this.onNameSubmitted,
    required this.barcodeController,
    required this.onScan,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const SizedBox(height: 16),
                Padding(
                  padding: const EdgeInsets.only(left: 16.0),
                  child: ProductImagePicker(
                    initialImagePath: initialImagePath,
                    onImageChanged: onImageChanged,
                    size: 120,
                    enabled: true,
                  ),
                ),
              ],
            ),
            const SizedBox(width: 16),
          ],
        ),
        const SizedBox(height: 16),
        AppTextField(
          controller: nameController,
          label: 'åç§°',
          isRequired: true,
          focusNode: nameFocusNode,
          onFieldSubmitted: (_) => onNameSubmitted(),
        ),
        const SizedBox(height: 16),
        BarcodeSection(
          controller: barcodeController,
          onScan: onScan,
        ),
      ],
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\inventory\presentation\widgets\outbound_record_item_tile.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/database/database.dart';
import '../../../product/application/provider/product_providers.dart';
import '../../application/provider/batch_providers.dart';

class OutboundRecordItemTile extends ConsumerWidget {
  final OutboundItemData item;

  const OutboundRecordItemTile({super.key, required this.item});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final productAsync = ref.watch(productByIdProvider(item.productId));
    final batchAsync = item.batchId != null
        ? ref.watch(batchByNumberProvider(item.batchId!))
        : null;

    return ListTile(
  contentPadding: const EdgeInsets.only(left: 3, right: 16, top: 0, bottom: 0),
  minVerticalPadding: 0,
  dense: true,
  visualDensity: const VisualDensity(horizontal: 0, vertical: -4),
  minLeadingWidth: 0,
      title: Row(
        children: [
            Text(' ${item.id}  ', style: const TextStyle(fontSize: 14)),
            const SizedBox(width: 6),
            Expanded(
              child: productAsync.when(
                data: (product) => Text(product?.name ?? 'è´§å“ID: ${item.productId}', style: const TextStyle(fontSize: 16)),
                loading: () => const Text('åŠ è½½ä¸­...'),
                error: (err, stack) => Text(
                  'åŠ è½½è´§å“å¤±è´¥',
                  style: TextStyle(color: Theme.of(context).colorScheme.error),
                ),
              ),
            ),
          ],
      ),
      trailing: Column(
        mainAxisSize: MainAxisSize.min, // é¿å… trailing æ‹‰ä¼¸å¯¼è‡´æ•´ä½“å˜é«˜
        mainAxisAlignment: MainAxisAlignment.center,
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          Text('æ•°é‡: ${item.quantity}') ,
          if (batchAsync != null)
            batchAsync.when(
              data: (batch) {
                if (batch?.productionDate == null) {
                  return const SizedBox.shrink();
                }
                return Text(
                  'ç”Ÿäº§æ—¥æœŸ: ${DateFormat('yyyy-MM-dd').format(batch!.productionDate)}',
                  style: const TextStyle(fontSize: 12, color: Colors.grey),
                );
              },
              loading: () => const SizedBox(
                  width: 12,
                  height: 12,
                  child: CircularProgressIndicator(strokeWidth: 2)),
              error: (e, s) => const SizedBox.shrink(),
            ),
        ],
      ),
    );
  }
}


// ============================================================
// æ–‡ä»¶: core\widgets\privacy_debug_helper.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

class PrivacyDebugHelper {
  /// æ£€æŸ¥éšç§æ”¿ç­–åŒæ„çŠ¶æ€
  static Future<Map<String, dynamic>> checkPrivacyStatus() async {
    final prefs = await SharedPreferences.getInstance();
    
    final oldKeyAgreed = prefs.getBool('privacy_policy_agreed');
    final newKeyAgreed = prefs.getBool('isPrivacyPolicyAgreed');
    
    return {
      'oldKey': oldKeyAgreed,
      'newKey': newKeyAgreed,
      'shouldShowDialog': !(newKeyAgreed == true || oldKeyAgreed == true),
      'allKeys': prefs.getKeys().toList(),
    };
  }
  
  /// é‡ç½®éšç§æ”¿ç­–çŠ¶æ€ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  static Future<void> resetPrivacyStatus() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('privacy_policy_agreed');
    await prefs.remove('isPrivacyPolicyAgreed');
  }
  
  /// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
  static void showDebugInfo(BuildContext context) async {
    final status = await checkPrivacyStatus();
    
    if (context.mounted) {
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('éšç§æ”¿ç­–è°ƒè¯•ä¿¡æ¯'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('æ—§KeyçŠ¶æ€: ${status['oldKey']}'),
              Text('æ–°KeyçŠ¶æ€: ${status['newKey']}'),
              Text('åº”æ˜¾ç¤ºå¼¹çª—: ${status['shouldShowDialog']}'),
              const SizedBox(height: 16),
              const Text('æ‰€æœ‰å­˜å‚¨çš„Keys:'),
              ...((status['allKeys'] as List).map((key) => Text('- $key'))),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('å…³é—­'),
            ),
            TextButton(
              onPressed: () async {
                await resetPrivacyStatus();
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('éšç§æ”¿ç­–çŠ¶æ€å·²é‡ç½®')),
                );
              },
              child: const Text('é‡ç½®çŠ¶æ€'),
            ),
          ],
        ),
      );
    }
  }
}

// ============================================================
// æ–‡ä»¶: features\backup\presentation\integration\settings_integration_example.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../widgets/backup_button.dart';

/// ç¤ºä¾‹ï¼šå¦‚ä½•å°†å¤‡ä»½åŠŸèƒ½é›†æˆåˆ°è®¾ç½®é¡µé¢
/// 
/// åœ¨ç°æœ‰çš„ _DataManagementSection ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
/// 
/// ```dart
/// // åœ¨ _DataManagementSection çš„ build æ–¹æ³•ä¸­æ·»åŠ ï¼š
/// const QuickBackupButton(),
/// const Divider(),
/// ```
/// 
/// æˆ–è€…åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„å¤‡ä»½ç®¡ç†éƒ¨åˆ†ï¼š
class BackupManagementSection extends ConsumerWidget {
  const BackupManagementSection({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Text(
            'æ•°æ®å¤‡ä»½',
            style: Theme.of(context).textTheme.titleMedium?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
        const QuickBackupButton(),
        ListTile(
          leading: const Icon(Icons.folder),
          title: const Text('ç®¡ç†å¤‡ä»½æ–‡ä»¶'),
          subtitle: const Text('æŸ¥çœ‹ã€åˆ é™¤æˆ–åˆ†äº«å·²åˆ›å»ºçš„å¤‡ä»½'),
          trailing: const Icon(Icons.arrow_forward_ios),
          onTap: () {
            // TODO: å¯¼èˆªåˆ°å¤‡ä»½ç®¡ç†é¡µé¢
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('å¤‡ä»½ç®¡ç†åŠŸèƒ½å³å°†æ¨å‡º')),
            );
          },
        ),
      ],
    );
  }
}

/// ä½¿ç”¨ç¤ºä¾‹ï¼š
/// 
/// åœ¨ SettingsScreen ä¸­ä½¿ç”¨ï¼š
/// ```dart
/// ListView(
///   children: [
///     // ... å…¶ä»–è®¾ç½®é¡¹
///     const Divider(),
///     const BackupManagementSection(),
///     // ... å…¶ä»–è®¾ç½®é¡¹
///   ],
/// )
/// ```

// ============================================================
// æ–‡ä»¶: features\inventory\presentation\widgets\inbound_record_item_tile.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/database/database.dart';
import '../../../product/application/provider/product_providers.dart';

class InboundRecordItemTile extends ConsumerWidget {
  final InboundItemData item;

  const InboundRecordItemTile({super.key, required this.item});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final productAsync = ref.watch(productByIdProvider(item.productId));
    // é¢„ç•™æ‰¹æ¬¡ä¿¡æ¯æŸ¥è¯¢ï¼Œæœªæ¥å¯èƒ½ä½¿ç”¨
    // final batchAsync = ref.watch(batchByNumberProvider(item.id));

    return ListTile(
      contentPadding: const EdgeInsets.only(
        left: 3,
        right: 16,
        top: 0,
        bottom: 0,
      ),
      minVerticalPadding: 0,
      dense: true,
      visualDensity: const VisualDensity(horizontal: 0, vertical: -4),
      minLeadingWidth: 0,
      title: Row(
        children: [
          Text(' ${item.id}  ', style: const TextStyle(fontSize: 14)),
          const SizedBox(width: 6),
          Expanded(
            child: productAsync.when(
              data: (product) => Text(
                product?.name ?? 'è´§å“ID: ${item.productId}',
                style: const TextStyle(fontSize: 16),
              ),
              loading: () => const Text('åŠ è½½ä¸­...'),
              error: (err, stack) => Text(
                'åŠ è½½è´§å“å¤±è´¥',
                style: TextStyle(color: Theme.of(context).colorScheme.error),
              ),
            ),
          ),
        ],
      ),
      trailing: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          Text(
            'æ•°é‡: ${item.quantity.toStringAsFixed(item.quantity.truncateToDouble() == item.quantity ? 0 : 2)}',
          ),
          
        ],
      ),
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\product_form_action_bar.dart
// ============================================================
import 'package:flutter/material.dart';

/// è¡¨å•åº•éƒ¨æ“ä½œæ ï¼ˆæäº¤æŒ‰é’®ï¼‰
class ProductFormActionBar extends StatelessWidget {
  final bool isLoading;
  final bool isEdit;
  final VoidCallback onSubmit;

  const ProductFormActionBar({
    super.key,
    required this.isLoading,
    required this.isEdit,
    required this.onSubmit,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).scaffoldBackgroundColor,
      ),
      child: SafeArea(
        child: SizedBox(
          width: double.infinity,
          height: 48,
          child: ElevatedButton(
            onPressed: isLoading ? null : onSubmit,
            style: ElevatedButton.styleFrom(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: isLoading
                ? const SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(strokeWidth: 2),
                  )
                : Text(
                    isEdit ? 'æ›´æ–°è´§å“' : 'æ·»åŠ è´§å“',
                    style: const TextStyle(fontSize: 16),
                  ),
          ),
        ),
      ),
    );
  }
}


// ============================================================
// æ–‡ä»¶: features\backup\presentation\widgets\auto_backup_settings_card.dart
// ============================================================
import 'package:flutter/material.dart';

/// è‡ªåŠ¨å¤‡ä»½è®¾ç½®å¡ç‰‡ç»„ä»¶
class AutoBackupSettingsCard extends StatelessWidget {
  final String title;
  final String? subtitle;
  final Widget? trailing;
  final VoidCallback? onTap;
  final IconData? leadingIcon;

  const AutoBackupSettingsCard({
    super.key,
    required this.title,
    this.subtitle,
    this.trailing,
    this.onTap,
    this.leadingIcon,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        leading: leadingIcon != null
            ? Icon(
                leadingIcon,
                color: Theme.of(context).colorScheme.primary,
              )
            : null,
        title: Text(
          title,
          style: Theme.of(context).textTheme.titleMedium,
        ),
        subtitle: subtitle != null
            ? Text(
                subtitle!,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                ),
              )
            : null,
        trailing: trailing,
        onTap: onTap,
      ),
    );
  }
}

// ============================================================
// æ–‡ä»¶: features\inventory\presentation\providers\outbound_records_provider.dart
// ============================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/database/database.dart';
import '../../data/dao/inventory_transaction_dao.dart';
import '../../domain/model/inventory_transaction.dart';

final inventoryTransactionDaoProvider =
    Provider<InventoryTransactionDao>((ref) {
  final db = ref.watch(appDatabaseProvider);
  return db.inventoryTransactionDao;
});

/// Provider to watch all outbound records, returning the full data objects.
final outboundRecordsProvider =
    FutureProvider<List<InventoryTransactionModel>>((ref) async {
  final dao = ref.watch(inventoryTransactionDaoProvider);
  final transactionsData = await dao.getAllTransactions();
  
  // Convert TableData to Domain Model
  final transactions = transactionsData.map((data) {
    return InventoryTransactionModel(
      id: data.id,
      productId: data.productId,
  // DB stores short codes: 'in' | 'out' | 'adjust' | 'transfer' | 'return'
  // Use converter to enum to avoid Bad state: No element
  type: inventoryTransactionTypeFromDbCode(data.transactionType),
      quantity: data.quantity,
      shopId: data.shopId,
      batchId: data.batchId,
      createdAt: data.createdAt,
    );
  }).toList();

  // Filter for outbound records
  final outboundTransactions = transactions
      .where((t) => t.isOutbound)
      .toList();
      
  // Sort by creation date descending
  outboundTransactions.sort((a, b) => b.createdAt!.compareTo(a.createdAt!));
  
  return outboundTransactions;
});

// ============================================================
// æ–‡ä»¶: core\constants\app_routes.dart
// ============================================================
// è·¯ç”±è·¯å¾„å¸¸é‡
class AppRoutes {
  static const String home = '/';
  static const String products = '/products';
  static const String productDetail = '/products/:id';
  static const String productEdit = '/product/:id/edit';
  static const String productNew = '/product/new';
  static const String productRanking = '/products/ranking';
  static const String categories = '/categories';
  static const String categoryTest = '/categories/test';
  static const String inventory = '/inventory';
  static const String inventoryQuery = '/inventory-query';
  static const String inventoryInboundRecords = '/inventory/inbound-records';
  static const String inbound = '/inbound';
  static const String inboundCreate = '/inbound/create';
  static const String purchase = '/purchase';
  static const String purchaseCreate = '/inbound/create';
  static const String purchaseRecords = '/purchase/records';
  static const String purchaseDetail = '/purchase/detail/:purchaseNumber';
  static const String sales = '/sales';
  static const String saleCreate = '/sales/create';
  static const String saleRecords = '/sales/records';
  static const String test = '/test';
  static const String databaseViewer = '/database-viewer';
  static const String databaseManagement = '/database-management';
  static const String settings = '/settings';
  static const String customers = '/customers';
  static const String productRestoreDebug = '/debug/product-restore';

  // è¾…åŠ©æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆå¸¦å‚æ•°çš„è·¯ç”±
  static String productDetailPath(String id) => '/products/$id';
  static String productEditPath(String id) => '/product/$id/edit';
  static String purchaseDetailPath(String purchaseNumber) =>
      '/purchase/detail/$purchaseNumber';
}


// ============================================================
// æ–‡ä»¶: config\flavor_config.dart
// ============================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';

// å®šä¹‰æ‰€æœ‰æ”¯æŒçš„ Flavor
enum AppFlavor {
  generic,
  personalized,
}

// å®šä¹‰åŠŸèƒ½å¼€å…³çš„æšä¸¾
enum Feature {
  showDatabaseTools,
}

// Flavor é…ç½®ç±»
class FlavorConfig {
  final AppFlavor flavor;
  final String appTitle;
  // åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šéœ€è¦æ ¹æ® Flavor å˜åŒ–çš„é…ç½®
  // ä¾‹å¦‚ï¼šAPI åœ°å€ã€ä¸»é¢˜é¢œè‰²ã€åŠŸèƒ½å¼€å…³ç­‰
  final Map<Feature, bool> featureFlags;

  FlavorConfig({
    required this.flavor,
    required this.appTitle,
    required this.featureFlags,
  });
}

// åˆ›å»ºä¸€ä¸ª Provider æ¥è®¿é—® FlavorConfig
final flavorConfigProvider = Provider<FlavorConfig>((ref) {
  // è¿™ä¸ª provider å¿…é¡»åœ¨ main å…¥å£æ–‡ä»¶ä¸­è¢« override
  throw UnimplementedError('flavorConfigProvider must be overridden in the main entry point.');
});

// ============================================================
// æ–‡ä»¶: features\settings\presentation\screens\privacy_policy_screen.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:markdown_widget/markdown_widget.dart';

class PrivacyPolicyScreen extends StatelessWidget {
  const PrivacyPolicyScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('éšç§æ”¿ç­–'),
      ),
      body: FutureBuilder(
        future: rootBundle.loadString('assets/text/privacy_policy.md'),
        builder: (BuildContext context, AsyncSnapshot<String> snapshot) {
          if (snapshot.connectionState == ConnectionState.done) {
            if (snapshot.hasError) {
              return Center(child: Text('åŠ è½½å¤±è´¥: ${snapshot.error}'));
            }
            if (snapshot.hasData) {
              return MarkdownWidget(
                data: snapshot.data!,
                padding: const EdgeInsets.all(16.0),
              );
            }
          }
          return const Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}

// ============================================================
// æ–‡ä»¶: features\settings\presentation\screens\terms_of_service_screen.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:markdown_widget/markdown_widget.dart';

class TermsOfServiceScreen extends StatelessWidget {
  const TermsOfServiceScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ç”¨æˆ·åè®®'),
      ),
      body: FutureBuilder(
        future: rootBundle.loadString('assets/text/terms_of_service.md'),
        builder: (BuildContext context, AsyncSnapshot<String> snapshot) {
          if (snapshot.connectionState == ConnectionState.done) {
            if (snapshot.hasError) {
              return Center(child: Text('åŠ è½½å¤±è´¥: ${snapshot.error}'));
            }
            if (snapshot.hasData) {
              return MarkdownWidget(
                data: snapshot.data!,
                padding: const EdgeInsets.all(16.0),
              );
            }
          }
          return const Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}

// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\async_value_widget.dart
// ============================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// åˆ›å»ºä¸€ä¸ªå¯å¤ç”¨çš„ Widget
class AsyncValueWidget<T> extends StatelessWidget {
  const AsyncValueWidget({
    super.key,
    required this.value,
    required this.data,
    this.loading,
    this.error,
  });

  final AsyncValue<T> value;
  final Widget Function(T data) data;
  final Widget? loading;
  final Widget Function(Object error, StackTrace stackTrace)? error;

  @override
  Widget build(BuildContext context) {
    return value.when(
      data: data,
      loading: () =>
          loading ?? const Center(child: CircularProgressIndicator()),
      error: (e, s) => error?.call(e, s) ?? Center(child: Text('Error: $e')),
    );
  }
}


// ============================================================
// æ–‡ä»¶: core\utils\snackbar_helper.dart
// ============================================================
import 'package:flutter/material.dart';

/// A helper function to show a SnackBar with a consistent style and duration.
///
/// [context]: The BuildContext from which to find the ScaffoldMessenger.
/// [message]: The text content of the SnackBar.
/// [isError]: Determines the background color of the SnackBar. Defaults to `false`.
void showAppSnackBar(
  BuildContext context, {
  required String message,
  bool isError = false,
}) {
  // Ensure the context is still valid before trying to show a SnackBar.
  if (!context.mounted) return;

  // Hide any currently displayed SnackBar to avoid queuing.
  ScaffoldMessenger.of(context).hideCurrentSnackBar();

  // Show the new SnackBar.
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(
      content: Text(message),
      duration: const Duration(milliseconds: 500),
      backgroundColor: isError ? Colors.redAccent : Colors.green,
      behavior: SnackBarBehavior.floating,
    ),
  );
}

// ============================================================
// æ–‡ä»¶: features\inventory\presentation\providers\outbound_receipts_provider.dart
// ============================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/database/database.dart';
import '../../../outbound/data/dao/outbound_item_dao.dart';

final outboundItemDaoProvider = Provider<OutboundItemDao>((ref) {
  final db = ref.watch(appDatabaseProvider);
  return db.outboundItemDao;
});

/// å®æ—¶ç›‘å¬æ‰€æœ‰å‡ºåº“è®°å½•ï¼Œæ•°æ®åº“æœ‰å˜åŒ–æ—¶è‡ªåŠ¨æ¨é€åˆ° UI
final outboundReceiptsProvider =
    StreamProvider<List<OutboundReceiptData>>((ref) {
  final database = ref.watch(appDatabaseProvider);
  return database.outboundReceiptDao
      .watchAllOutboundReceipts()
      .map((receipts) {
    final sorted = List<OutboundReceiptData>.of(receipts)
      ..sort((a, b) => b.createdAt.compareTo(a.createdAt));
    return sorted;
  });
});

final outboundReceiptItemsProvider =
    FutureProvider.family<List<OutboundItemData>, int>((ref, recordId) {
  final dao = ref.watch(outboundItemDaoProvider);
  return dao.getOutboundItemsByReceiptId(recordId);
});


// ============================================================
// æ–‡ä»¶: features\inventory\presentation\providers\inbound_records_provider.dart
// ============================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/database/database.dart';
import '../../../inbound/data/dao/inbound_item_dao.dart';

final inboundItemDaoProvider = Provider<InboundItemDao>((ref) {
  final db = ref.watch(appDatabaseProvider);
  return db.inboundItemDao;
});

final inboundRecordsProvider =
    FutureProvider<List<InboundReceiptData>>((ref) async {
  final database = ref.read(appDatabaseProvider);
  final receipts = await database.inboundReceiptDao.getAllInboundReceipts();
  receipts.sort((a, b) => b.createdAt.compareTo(a.createdAt));
  return receipts;
});

final inboundRecordItemsProvider =
    FutureProvider.family<List<InboundItemData>, int>((
  ref,
  recordId,
) {
  final dao = ref.watch(inboundItemDaoProvider);
  return dao.getInboundItemsByReceiptId(recordId);
});


// ============================================================
// æ–‡ä»¶: core\utils\sound_helper.dart
// ============================================================
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'package:audioplayers/audioplayers.dart';

/// éŸ³æ•ˆæ’­æ”¾å·¥å…·ç±»
class SoundHelper {
  static final AudioPlayer _audioPlayer = AudioPlayer();

  /// æ’­æ”¾æ‰«ç æˆåŠŸéŸ³æ•ˆ
  static Future<void> playSuccessSound() async {
    try {
      await _audioPlayer.stop();
      await _audioPlayer.play(AssetSource('sounds/scan_success2.mp3'));
    } catch (e) {
      if (kDebugMode) {
        print('æ’­æ”¾éŸ³æ•ˆå¤±è´¥ï¼Œä½¿ç”¨ç³»ç»ŸéŸ³æ•ˆ: $e');
      }
      SystemSound.play(SystemSoundType.click);
    }
  }
}

// ============================================================
// æ–‡ä»¶: features\product\presentation\screens\screens.dart
// ============================================================
// Product Screens Barrel File
// ç»Ÿä¸€å¯¼å‡ºäº§å“ç›¸å…³çš„é¡µé¢ç»„ä»¶

export 'product_add_edit_screen.dart';
export 'product_detail_screen.dart';
export 'product_list_screen.dart';
export 'product_selection_screen.dart';
export 'category_selection_screen.dart';
export 'unit_selection_screen.dart';
export 'auxiliaryunit_edit_screen.dart';
export 'product_ranking_screen.dart';


// ============================================================
// æ–‡ä»¶: features\product\presentation\widgets\widgets.dart
// ============================================================
// Product Widgets Barrel File
// ç»Ÿä¸€å¯¼å‡ºäº§å“ç›¸å…³çš„ Widget ç»„ä»¶

export 'product_image_picker.dart';
export 'unit_list_tile.dart';

// å¯¼å‡ºé¡µé¢ç»„ä»¶
export '../screens/screens.dart';


// ============================================================
// æ–‡ä»¶: features\inbound\inbound.dart
// ============================================================
// Inbound Feature Barrel File
export 'domain/model/models.dart';
export 'presentation/screens/screens.dart';
export 'presentation/widgets/widgets.dart';


// ============================================================
// æ–‡ä»¶: core\shared_widgets\shared_widgets.dart
// ============================================================
export 'loading_widget.dart';
export 'error_widget.dart';
export '../services/toast_service.dart';


// ============================================================
// æ–‡ä»¶: features\inventory\presentation\screens\screens.dart
// ============================================================
// åº“å­˜åŠŸèƒ½ç›¸å…³é¡µé¢ç»Ÿä¸€å¯¼å‡º
export 'inventory_query_screen.dart';
export 'inventory_records_screen.dart';


// ============================================================
// æ–‡ä»¶: core\utils\utils.dart
// ============================================================
export 'unit_converter.dart';
export 'product_unit_extensions.dart';


// ============================================================
// æ–‡ä»¶: features\inbound\presentation\screens\screens.dart
// ============================================================
// Inbound Screens Barrel File
export 'create_inbound_screen.dart';


// ============================================================
// æ–‡ä»¶: features\inbound\presentation\widgets\widgets.dart
// ============================================================
// Inbound Widgets Barrel File
export 'inbound_item_card.dart';


// ============================================================
// æ–‡ä»¶: features\purchase\presentation\screens\screens.dart
// ============================================================
// é‡‡è´­ç›¸å…³å±å¹•å¯¼å‡º
export 'purchase_records_screen.dart';


// ============================================================
// æ–‡ä»¶: core\widgets\product_list\index.dart
// ============================================================
export 'product_item.dart';
export 'product_list.dart';